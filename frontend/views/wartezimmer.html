{% load i18n %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" href="/static/images/favicon.ico"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1"/>
    <meta name="theme-color" content="#51ceec"/>
    <meta name="description" content="ARK"/>
    <title>Waiting-Room-SQUAD</title>
    <link rel="stylesheet" href="/static/css/app.css">
    <link rel="stylesheet" href="/static/css/wartezimmer.css">
    <link rel="stylesheet" href="/static/css/heatmap.css">

    <!-- vue cdn  -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!-- axios cdn -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

</head>
<body>
 {% get_current_language as LANGUAGE_CODE %}
 <div class="app">
    <div class="app__head">
        <header class="header-main container">
            <div class="header-main__title">
                <icon classs="icon" onClick="window.open('https://info.arks.ch/');">
                <span class="icon-logo"></span>
                <span>ARK</span>
            </div>
            <div class="header-main__user">
                <div class="user">
                    <div class="user__subtitle">
                        {{game.name}}
                        <span class="icon-link" data-clipboard-text="#link_url"></span>
                    </div>
                    <img src="{{avatar}}" alt="boar">
                    <div class="user__title">
                        <!-- Vasilisa Kochetkova  -->
                        {{user.name}}
                    </div>
                </div>
            </div>
            <div class="header-main__progress">
                <div class="progress">
                    <label>Mission 1</label>
                    <div class="progress__bar">
                        <div style="width: 20%">20%</div>
                    </div>
                </div>
            </div>
        </header>
    </div>
    <div class="app__body">
        <div class="container">



            <main class="screen wartezimmer">
                <div class="wartezimmer__data" id="app-2">
                    <h1>
                        {% trans "Bitte tauscht euch jetzt aus." %}
                    </h1>
                    <p>
                        {% trans "Erzählt euch bitte kurz gegenseitig, welches GEGENSATZPAAR Du ausgewählt hast, damit alle verstehen können, wovon die Rede ist." %}
                        <br/>
                    </p>
                    <img src="http://info.arks.ch/wp-content/uploads/2022/07/Plus_Minus.png">
                    <p>
                        <b>
                        {% trans "Überprüfe bitte noch einmal das von Dir gewählte GEGENSATZPAAR und überarbeite Deine Begriffe bei Bedarf..." %}
                        <br><br>
                        </b>
                    <input type="text" placeholder="Kraftquelle fehlt!" name="Kraftquelle" v-model="text_input_power" />
                    <input type="text" placeholder="Energiefresser fehlt!" name="Energiefresser" v-model="text_input_drainer" />

                    <button class="glow-on-hover" type="button" @click="continue_()">Update</button>
                    
                    </p>
                        <p v-for='(value, index) in 10' :key="index">
                            {{ x }}
                        </p>                     
                </div>

<!--
                <div class="heatmap">


          <div class="main-column prop">
            <div class="corner"></div>
            <div class="corner"></div>
            <div class="property" v-for="scale in scale_list_pro">
              <p class="property_one">[[ scale[0] ]]</p>
              <p class="property_two">[[ scale[1] ]]</p>
            </div>
            {% comment %} <div class="property">
              <p class="property_one">Curative</p>
              <p class="property_two">Narcissism</p>
            </div>
            <div class="property">
              <p class="property_one">Ambition</p>
              <p class="property_two">Enforcement</p>
            </div>
            <div class="property">
              <p class="property_one">Victory</p>
              <p class="property_two">Dominance</p>
            </div>
            <div class="property">
              <p class="property_one">Pain</p>
              <p class="property_two">Invisibility</p>
            </div> {% endcomment %}

          </div>


                </div>
-->
                <div class="wartezimmer__addition" id="app-1">

                    <div class="user-connect active" v-for='(value, index) in waiting_list_active'>
                        <img :src="value.avatar" alt=""/>
                        <div class="user-connect__name">
                            [[ value.name ]]
                        </div>
                        <div class="user-connect__now">
                            {% trans "bereit" %}
                        </div>
                    </div>

                    <div class="user-connect" v-for='(value, index) in waiting_list_yet'>
                        <img :src="value.avatar" alt=""/>
                        <div class="user-connect__name">
                            [[ value.name ]]
                        </div>
                        <div class="user-connect__now">
                            {% trans "bereit" %}
                        </div>
                    </div>
                    {% comment %} <div class="user-connect">
                        <img src="/static/images/avatars/penguin-1.svg" alt=""/>
                        <div class="user-connect__name">
                            Constantin
                            Constantinopol
                        </div>
                        <div class="user-connect__now">
                            {% trans "bereit" %}
                        </div>
                    </div>
                    <div class="user-connect active">
                        <img src="/static/images/avatars/penguin-1.svg" alt=""/>
                        <div class="user-connect__name">
                            Constantin
                            Constantinopol
                        </div>
                        <div class="user-connect__now">
                            {% trans "bereit" %}
                        </div>
                    </div>
                    <div class="user-connect">
                        <img src="/static/images/avatars/penguin-1.svg" alt=""/>
                        <div class="user-connect__name">
                            Constantin
                            Constantinopol
                        </div>
                        <div class="user-connect__now">
                            {% trans "bereit" %}
                        </div>
                    </div>
                    <div class="user-connect">
                        <img src="/static/images/avatars/penguin-1.svg" alt=""/>
                        <div class="user-connect__name">
                            Constantin
                            Constantinopol
                        </div>
                        <div class="user-connect__now">
                            {% trans "bereit" %}
                        </div>
                    </div>
                    <div class="user-connect">
                        <img src="/static/images/avatars/penguin-1.svg" alt=""/>
                        <div class="user-connect__name">
                            Constantin
                            Constantinopol
                        </div>
                        <div class="user-connect__now">
                            {% trans "bereit" %}
                        </div>
                    </div>
                    <div class="user-connect">
                        <img src="/static/images/avatars/penguin-1.svg" alt=""/>
                        <div class="user-connect__name">
                            Constantin
                            Constantinopol
                        </div>
                        <div class="user-connect__now">
                            {% trans "bereit" %}
                        </div>
                    </div>
                    <div class="user-connect">
                        <img src="/static/images/avatars/penguin-1.svg" alt=""/>
                        <div class="user-connect__name">
                            Constantin
                            Constantinopol
                        </div>
                        <div class="user-connect__now">
                            {% trans "bereit" %}
                        </div>
                    </div>
                    <div class="user-connect">
                        <img src="/static/images/avatars/penguin-1.svg" alt=""/>
                        <div class="user-connect__name">
                            Constantin
                            Constantinopol
                        </div>
                        <div class="user-connect__now">
                            {% trans "bereit" %}
                        </div>
                    </div>
                    <div class="user-connect">
                        <img src="/static/images/avatars/penguin-1.svg" alt=""/>
                        <div class="user-connect__name">
                            Constantin
                            Constantinopol
                        </div>
                        <div class="user-connect__now">
                            {% trans "bereit" %}
                        </div>
                    </div>
                    <div class="user-connect">
                        <img src="/static/images/avatars/penguin-1.svg" alt=""/>
                        <div class="user-connect__name">
                            Constantin
                            Constantinopol
                        </div>
                        <div class="user-connect__now">
                            {% trans "bereit" %}
                        </div>
                    </div>
                    <div class="user-connect">
                        <img src="/static/images/avatars/penguin-1.svg" alt=""/>
                        <div class="user-connect__name">
                            Constantin
                            Constantinopol
                        </div>
                        <div class="user-connect__now">
                            {% trans "bereit" %}
                        </div>
                    </div>
                    <div class="user-connect">
                        <img src="/static/images/avatars/penguin-1.svg" alt=""/>
                        <div class="user-connect__name">
                            Constantin
                            Constantinopol
                        </div>
                        <div class="user-connect__now">
                            {% trans "bereit" %}
                        </div>
                    </div>
                    <div class="user-connect">
                        <img src="/static/images/avatars/penguin-1.svg" alt=""/>
                        <div class="user-connect__name">
                            Constantin
                            Constantinopol
                        </div>
                        <div class="user-connect__now">
                            {% trans "bereit" %}
                        </div>
                    </div>  {% endcomment %}
                </div>
            </main>

            <form action="#" method="POST" class="form">
            {% csrf_token %}
                <div class="center">
                    <button id='main_btn' type="button" onclick="choosePopup()">
                        {% trans "Weiterspielen" %}
                    </button>
                    <p><br>
                        {% trans "Starte richtig durch, sobald alle Mitspieler hier im Warteraum sichtbar sind. Nur wer jetzt mit an Bord ist, nimmt an der Reise Teil!" %}
                    </p>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.min.js"></script>
<script src="https://unpkg.com/tippy.js@6/dist/tippy-bundle.umd.js"></script>
<script src="https://unpkg.com/clipboard@2/dist/clipboard.min.js"></script>
<script>

    var scaleI18n = {{scale|safe}} ;
    var scale = [];
    var lang_code = '{{LANGUAGE_CODE}}';
    scaleI18n.forEach( (item) => {
        scale.push(item[lang_code]);
    });


    //Button remover
    function buttonRemover() {
      let initiator = "{{host}}";
      let user = "{{player_name}}";
      console.log(initiator, user);
      let btn = document.querySelector('#main_btn')
      if (initiator != user) {
        btn.style.display = 'none'
      }
    }
    buttonRemover();

    // Copy and tooltip
    new ClipboardJS('.icon-link');
    tippy('.icon-link', {
      content: 'Copy gamelink to clipboard',
    });
    tippy('.icon-link', {
      trigger: 'click',
      content: 'Copied',
    });

    // Link creation
    // TODO Code bellow Link must be from backend.
    var temp_link = '{{game.link}}';
    var url_host = window.location.host;
    var temp_link_ = url_host + '/link/' + temp_link + '/';
    document.querySelector('.icon-link').dataset.clipboardText = temp_link_;

   var app2 = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app-2',
        data() {
            return {
                scale: scale,
                text_input_power : scale[0],
                text_input_drainer : scale[1]
            }
        },
        methods: {
            handleSelect(key, keyPath) {
                console.log(key, keyPath);
            },
            continue_(){
                var that = this;
                if (that.text_input_power === ''){
                    alert("Please choose a power term.");
                    return;
                } else if (that.text_input_drainer === '') {
                    alert("Please choose a drainer term.");
                    return;
                } else {
                    //if (this.keyboard_input === true){
                    app2.add_terms();
                }
            },
            add_terms(){
                var that = this;
                var tempPower = that.text_input_power;
                tempPower = tempPower.replace(/\s*/g,"")
                if (that.text_input_power ===  ''){
                    return;
                }
                if (tempPower === ''){
                    return;
                }

                var tempDrainer = that.text_input_drainer;
                tempDrainer = tempDrainer.replace(/\s*/g,"")
                if (that.text_input_drainer ===  ''){
                    return;
                }
                if (tempDrainer === ''){
                    return;
                }

                var data_ = {
                    'player_id': '{{user.id}}',
                    'link': '{{game.link}}',
                    'item_power': tempPower,
                    'item_drainer': tempDrainer,
                    'lang_code': '{{LANGUAGE_CODE}}'
                };
                axios
                    .post(`/api/warteimmer_api_pro/`, data_)
                    .then(function(response){
                        var result = response.data.result;
                        console.log(result);
                    })
                    .catch(function(error){
                        console.log(error);
                    })

            }
        }
    });


    var app = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app-1',
        data() {
            return {
                activeIndex: '1',
                message: 'Hello Vue!',
                waiting_list_active: [
                {
                    'id': -1,
                    'name': '',
                    'avatar': '',
                }],
                waiting_list_yet:[{
                    'id': -1,
                    'name': '',
                    'avatar': '',
                }],
            }
        },
        methods: {
            handleSelect(key, keyPath) {
                console.log(key, keyPath);
            },
        },
    })


    function popupOpen(selector) {
      console.log('opened', selector);
      selector.classList.add('open');
    }

    function popupClose(selector, timeout) {
      console.log('closed', selector);
      setTimeout(() => {selector.classList.remove('open')}, timeout);

    }

    function choosePopup() {
      let userList = document.querySelectorAll('.user-connect');
      let readyCount = 0;
      for (let item of userList) {
        if(item.classList.contains('active')) {
          readyCount++;
        }
      }
      if (userList.length < 3) {
        morePlayersNeeded();
      }
      else if (userList.length >= 3 && readyCount < 3) {
        letsWaitMorePlayers();
      }
      else if (userList.length >= 3 && readyCount >=3 && userList.length > readyCount){
        waitOrGo();
        console.log('waitOrGo')
      }
      else if (userList.length == readyCount) {
        start();
      }
    }

    function morePlayersNeeded() {
      let popup = document.querySelector('#popup_less_players');
      popupOpen(popup);
      popupClose(popup, 1500);
    }

    function letsWaitMorePlayers() {
      let popup = document.querySelector('#popup_less_ready_players');
      popupOpen(popup);
      popupClose(popup, 1500);
    }

    function waitOrGo() {
      let popup = document.querySelector('#popup_buttons');
      popupOpen(popup);
      let closeBtn = document.querySelector('.modal_button[type=button]')
      console.log(closeBtn);
      closeBtn.addEventListener('click', () => {popupClose(popup)})
    }

    function start() {
      document.forms[0].submit();
    }

    function sleep (time) {
        return new Promise((resolve) => setTimeout(resolve, time));
    }

    async function get_mem_list(){
        while (1){
            var waiting_post = {"player_id": "{{player_id}}","link":"{{link}}"};
            await sleep(3000).then(() => {
                axios
                    .post(`/api/waiting_room_active/`,waiting_post)
                    .then(function(response){
                        var result = response.data.result;
                        //console.log('result', result);
                        app.waiting_list_active.splice(0);
                        var uu = 0;
                        while (uu < result.length){
                            app.waiting_list_active.push((result)[uu]);
                            uu += 1;
                        }
                        app.waiting_list_active = result;

                        axios
                            .post(`/api/waiting_room_yet/`,waiting_post)
                            .then(function(response){
                                var result = response.data.result;
                                //console.log('result', result);
                                app.waiting_list_yet.splice(0);
                                var uu = 0;
                                while (uu < result.length){
                                    app.waiting_list_yet.push((result)[uu]);
                                    uu += 1;
                                }
                                app.waiting_list_yet = result;

                            })
                            .catch(function(error) { // 请求失败处理
                                console.log(error);
                            });

                    })
                    .catch(function(error) { // 请求失败处理
                        console.log(error);
                    });
            })
            
        }
    }

    async function check_game_start(){
        var uu = 0
        while (1){
            if (uu%10 === 9){
                alert("Time-out. Please click, if you are ready to continue.")
            }
            var data_ = {'link': '{{link}}'};
            var user_ = {'user_id': '{{user.id}}'}
            await sleep(50000).then(() => {
                axios
                    .post(`/api/check_ubung1_ubung3_blank/`, user_)
                    .then(function(response){
                        var result = response.data.result;
                        if (result === '1'){
                            window.location.href = '/ubung-1/'
                        }
                        if (result === '3'){
                            window.location.href = '/ubung-3/'
                        }

                        axios
                            .post(`/api/waiting_room_game_start/`, data_)
                            .then(function(response){
                                var result = response.data.result;
                                    if (result === 1){
                                        window.location.href="/ubung-5/";
                                    }else{
                                        uu += 1
                                        console.log(uu)
                                    }
                                })
                            .catch(function(error){
                                console.log(error);
                            });

                    })
                    .catch(function(error){
                        console.log(error)
                    })
            })
        }
    }  

    get_mem_list()
    check_game_start()







</script>
<div id='popup_buttons' class="popup">
    <div class="popup_body">
        <div class="popup_content">
            <form class="popup_form" action="#" method="post">
              {% csrf_token %}
              <button class="modal_button" type="submit" id="button" >Continue playing with </br> Green players</button>
              <button class="modal_button" type="button" >Wait for </br> More players</button>
            </form>
        </div>
    </div>
</div>
<div id='popup_less_players' class="popup">
    <div class="popup_body">
        <div class="popup_content">
            Invite more players! It takes at least 3 to play this game.
        </div>
    </div>
</div>
<div id='popup_less_ready_players' class="popup">
    <div class="popup_body">
        <div class="popup_content">
            Wait until more players have been arriving here in the waiting room.
        </div>
    </div>
</div>
</body>
</html>
