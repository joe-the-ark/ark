{% load i18n %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" href="/static/images/favicon.ico"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1"/>
    <meta name="theme-color" content="#51ceec"/>
    <meta name="description" content="ARK"/>
    <title>Team-Potential-VOTE</title>
    <link rel="stylesheet" href="/static/css/app.css">
    <link rel="stylesheet" href="/static/css/ubung-2.css">
</head>
<body>
<div class="app">
    <div class="app__head">
        <header class="header-main container">
            <div class="header-main__title">
                <icon classs="icon" onClick="window.open('https://info.arks.ch/');" style="cursor: pointer; position: relative; display: inline-flex; align-items: center;">
                <span class="icon-logo"></span>
                <span>ARKS</span>
                <span class="tooltip-icon arks-logo-tooltip" id="arks-logo-tooltip-icon" style="display: none; margin-left: 8px;">{% trans "Info zu safecircles.ch" %}</span>
            </icon>
            </div>
            <div class="header-main__user" style="background-color: #FFFFFF; color: #626262; border-radius: 10px; padding: 0 10px;">
              <div class="language-selector" style="display:inline-block;">
                <form action="{% url 'set_language' %}" method="post" style="vertical-align:middle;">{% csrf_token %}
                    <input name="next" type="hidden" value="">
                    {% get_current_language as LANGUAGE_CODE %}
                    {% if LANGUAGE_CODE == 'zh-hans' %}
                        <img id="flag" src="{% static 'images/flags/4_zh-hans_transparent.png' %}" style="width:20%;vertical-align:middle;padding-left:1px" alt="language flag">
                    {% elif LANGUAGE_CODE == 'de' %}
                        <img id="flag" src="{% static 'images/flags/1_de_transparent.png' %}" style="width:20%;vertical-align:middle;padding-left:1px" alt="language flag">
                    {% elif LANGUAGE_CODE == 'fr' %}
                        <img id="flag" src="{% static 'images/flags/3_fr_transparent.png' %}" style="width:20%;vertical-align:middle;padding-left:1px" alt="language flag">
                    {% elif LANGUAGE_CODE == 'tr' %}
                        <img id="flag" src="{% static 'images/flags/5_tr_transparent.png' %}" style="width:20%;vertical-align:middle;padding-left:1px" alt="language flag">
                    {% else %}
                    <img id="flag" src="{% static 'images/flags/2_en_transparent.png' %}" style="width:20%;vertical-align:middle;padding-left:1px" alt="language flag">
                    {% endif %}
                    <select onchange="updateLanguageFlag(); this.form.submit();" name="language" id="select_" style="width: auto; vertical-align:middle; border-radius: 10px; padding: 10px;" aria-label="{% trans 'Sprache auswÃ¤hlen' %}">
                        <option value="" selected>{% trans "Sprachauswahl" %}</option>
                        {% get_available_languages as LANGUAGES %}
                        {% get_language_info_list for LANGUAGES as languages %}
                        {% for language in languages %}
                            <option value="{{ language.code }}">
                                {{ language.name_local|capfirst }}
                            </option>
                        {% endfor %}
                    </select>
                </form>
              </div>
                <div class="user">
                    <div class="user__subtitle">
                        {{ game.name }}<br>
                        <button class="copy-link-button" id="copy-link-button" type="button" aria-label="{% trans 'Link kopieren' %}" data-clipboard-text="#link_url">
                            <span class="copy-link-icon">ðŸ“‹</span>
                            <span class="copy-link-text">{% trans "Link kopieren" %}</span>
                            <span class="copy-link-success" style="display: none;">âœ“ {% trans "Kopiert!" %}</span>
                        </button>
                    </div>
                    <img src="{{user.avatar}}" alt="{{user.name}}">
                    <div class="user__title">
                        {{user.name}}
                    </div>
                </div>
            </div>
            <div class="header-main__progress">
                <div class="progress">
                    <label>{% trans "ANONYM" %}</label>
                    <div class="progress__bar">
                        <div style="width: 5%; border-radius: 10px;
                        ">5%</div>
                    </div>
                </div>
            </div>
        </header>
    </div>
    <div class="app__body">
        <div class="container">
            <form id="form_" action="#" method="POST" id="ubung-1-form" class="form" onkeypress="javascript: if (event.keyCode==13 || event.onclick){return false;}">
            {% csrf_token %}
                <main class="screen ubung-2">
                    <h1>
                        {% trans "Wie gut nutzt ihr euer Potential in der Zusammenarbeit?" %}
                    </h1>
                    <div style="border: 1px solid #ccc; border-radius: 10px; padding: 30px;">
                    <p>
                        {% trans "SchÃ¤tze anonym die aktuelle durchschnittliche Performance dieses Teams auf einer Skala von 1 (low performing) bis 99 (high performing) ein." %}
                        <span class="tooltip-icon slider-tooltip-icon" id="slider-tooltip-icon" style="display: inline-flex; align-items: center; margin-left: 8px; vertical-align: middle;">?</span>
                    </p>
                    <div class="ui-slider">
                        <div class="ui-slider__marker">
                            <div class="ui-slider__marker-thumb">
                                <span>0</span>
                                <img src="{{user.avatar}}" alt=""/>
                            </div>
                            <div class="ui-slider__marker-name">
                                {{user.name}} {% trans "schÃ¤tzt" %}
                            </div>
                        </div>
                        <div class="ui-slider__range">
                            <input id="ui-range" class="input-range" type="range" value="0" min="1" max="99">
                        </div>
                    </div>
                    <p style="background-color: #9FE2BF; color: #626262; border-radius: 10px; padding: 0 10px;">
                        {% trans "Bewege bitte deinen Avatar auf den Punkt der Skala, der am besten passt. SpÃ¤ter siehst du die ANONYMISIERTE EinschÃ¤tzung aller Mitreisenden." %}<br><br>
                    </p>
                    <input id="digit_value" type="hidden" name="digit_value" value="0">
                </div>
                     <div class="center">
                        <p>
                        <button class="button button-primary" type="button" id="submit-button" aria-label="{% trans 'Weiter' %}">
                            <span class="button-text">{% trans "Weiter" %}</span>
                            <span class="button-arrow">â†’</span>
                        </button>
                        </p>
                        <div id="validation-error" class="validation-error" role="alert" aria-live="polite" style="display: none;">
                            <strong>{% trans "Bitte bewege den Slider" %}</strong><br>
                            <span class="validation-error-text">{% trans "Du musst eine Bewertung zwischen 1 und 99 abgeben, bevor du fortfahren kannst." %}</span>
                        </div>
                        <div class="copyright-footer">
                            <a href="https://github.com/joe-the-ark/ark" target="_blank">{% trans "ARKS is published under a GPLv3" %}</a> {% trans "license by" %} 
                            <a href="https://www.linkedin.com/in/dr-joe-maier/" target="_blank">{% trans "Dr. Joe Maier" %}</a>.
                        </div>
                    </div>
                </main>
            </form>
        </div>
    </div>
</div>
<script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.min.js"></script>
<script src="https://unpkg.com/tippy.js@6/dist/tippy-bundle.umd.js"></script>
<script src="https://unpkg.com/clipboard@2/dist/clipboard.min.js"></script>
<script src="/static/jquery-3.5.1.min.js"></script>
<script src="/static/js/AppUiSlider.js"></script>
<script>
        // Link creation
        var temp_link = '{{ game.link }}';
        var url_host = window.location.host;
        var temp_link_ = url_host + '/link/' + temp_link;
        
        // Copy link button with improved feedback
        const copyLinkButton = document.getElementById('copy-link-button');
        const copyLinkText = copyLinkButton ? copyLinkButton.querySelector('.copy-link-text') : null;
        const copyLinkSuccess = copyLinkButton ? copyLinkButton.querySelector('.copy-link-success') : null;
        
        if (copyLinkButton) {
            copyLinkButton.dataset.clipboardText = temp_link_;
            const clipboard = new ClipboardJS(copyLinkButton);
            
            clipboard.on('success', function(e) {
                e.clearSelection();
                
                // Show success feedback
                if (copyLinkText) copyLinkText.style.display = 'none';
                if (copyLinkSuccess) {
                    copyLinkSuccess.style.display = 'inline';
                    copyLinkButton.classList.add('copy-link-button--success');
                }
                
                // Reset after 2 seconds
                setTimeout(function() {
                    if (copyLinkText) copyLinkText.style.display = 'inline';
                    if (copyLinkSuccess) copyLinkSuccess.style.display = 'none';
                    copyLinkButton.classList.remove('copy-link-button--success');
                }, 2000);
            });
            
            clipboard.on('error', function(e) {
                console.error('Failed to copy link:', e);
            });
        }
        
        // ARKS Logo Tooltip
        const arksLogoContainer = document.querySelector('.header-main__title icon');
        const arksLogoTooltipIcon = document.getElementById('arks-logo-tooltip-icon');
        
        if (arksLogoContainer && arksLogoTooltipIcon) {
            arksLogoContainer.addEventListener('mouseenter', function() {
                arksLogoTooltipIcon.style.display = 'inline-flex';
            });
            arksLogoContainer.addEventListener('mouseleave', function() {
                arksLogoTooltipIcon.style.display = 'none';
            });
            
            tippy(arksLogoTooltipIcon, {
                content: "{% trans 'Info zu safecircles.ch'|escapejs %}",
                placement: 'bottom',
                theme: 'light',
                delay: [200, 0],
                allowHTML: false,
                interactive: false,
                trigger: 'mouseenter focus',
                maxWidth: 300,
            });
        }
        
        // Slider Tooltip
        const sliderTooltipIcon = document.getElementById('slider-tooltip-icon');
        if (sliderTooltipIcon) {
            tippy(sliderTooltipIcon, {
                content: "{% trans '1 = niedrige Performance, 99 = hohe Performance. Die Skala zeigt die durchschnittliche Team-Performance.'|escapejs %}",
                placement: 'top',
                theme: 'light',
                delay: [200, 0],
                allowHTML: false,
                interactive: false,
                trigger: 'mouseenter focus',
                maxWidth: 300,
            });
        }


    new AppUiSlider({
        inputSlider: '#ui-range',
        countSlider: '.ui-slider__marker-thumb span',
        thumbSlider: '.ui-slider__marker',
        rangeMaxWidthContainer: 973 - 110,
        range: {
            min: 1,
            max: 99
        },
        callback(value) {
            $('#digit_value').val(value);
        }
    });

    // Improved validation with translated messages
    function check_zero(){
        var value = $('#digit_value').val();
        const validationError = document.getElementById('validation-error');
        
        if (value === '0' || value === 0 || !value){
            // Show error message
            if (validationError) {
                validationError.style.display = 'block';
                validationError.setAttribute('role', 'alert');
                
                // Focus on slider
                const slider = document.getElementById('ui-range');
                if (slider) {
                    slider.focus();
                    slider.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                // Hide error after 8 seconds
                setTimeout(function() {
                    if (validationError) {
                        validationError.style.display = 'none';
                    }
                }, 8000);
            }
            return false;
        } else {
            // Hide error if visible
            if (validationError) {
                validationError.style.display = 'none';
            }
            
            // Add visual feedback before submit
            const submitButton = document.getElementById('submit-button');
            if (submitButton) {
                submitButton.classList.add('button-submitting');
                submitButton.disabled = true;
                submitButton.textContent = "{% trans 'Wird verarbeitet...'|escapejs %}";
            }
            
            var form_submit = document.getElementById('form_');
            if (form_submit) {
                form_submit.submit();
            }
            return true;
        }
    }

    // Submit button click handler
    const submitButton = document.getElementById('submit-button');
    if (submitButton) {
        submitButton.addEventListener('click', function(e) {
            e.preventDefault();
            check_zero();
        });
    }
    
    // Allow Enter key to submit
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.id === 'ui-range') {
            e.preventDefault();
            check_zero();
        }
    });

    // Update flag based on current language
    function updateLanguageFlag() {
        var lang_code = $('#select_').val();
        if (lang_code == 'zh-hans'){
            $("#flag").attr("src", "{% static 'images/flags/4_zh-hans_transparent.png'%}");
        } else if (lang_code == 'de'){
            $("#flag").attr("src", "{% static 'images/flags/1_de_transparent.png'%}");
        } else if (lang_code == 'en'){
            $("#flag").attr("src", "{% static 'images/flags/2_en_transparent.png'%}");
        } else if (lang_code == 'fr'){
            $("#flag").attr("src", "{% static 'images/flags/3_fr_transparent.png'%}");
        } else if (lang_code == 'tr'){
            $("#flag").attr("src", "{% static 'images/flags/5_tr_transparent.png' %}");
        }
    }
    
    // Initialize language flag on page load
    updateLanguageFlag();
    
    // Set "Sprachauswahl" as default display in select (flag shows current language)
    $(document).ready(function() {
        $('#select_').val('');
    });

</script>
</body>
</html>
