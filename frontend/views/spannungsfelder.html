{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" href="/static/images/favicon.ico"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1"/>
    <meta name="theme-color" content="#51ceec"/>
    <meta name="description" content="Web site"/>
    <title>Team-Tensions-RESULT</title>
    <link rel="stylesheet" href="/static/css/app.css">
    <link rel="stylesheet" href="/static/css/app_graph.css">
    <link rel="stylesheet" href="/static/css/spannungsfelder.css">
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">
</head>
<body>
<div class="app">
    <div class="app__head">
        <header class="header-main container">
            <div class="header-main__title">
                <span class="icon-logo"></span>
                <span>ARK</span>
            </div>
            <div class="header-main__user">
                <div class="user">
                    <div class="user__subtitle">
                        {{game.name}}
                    </div>
                    <img src="{{user.avatar}}" alt="">
                    <div class="user__title">
                        {{user.name}}
                    </div>
                </div>
            </div>
            <div class="header-main__progress">
                <div class="progress">
                    <label>Mission 1</label>
                    <div class="progress__bar">
                        <div style="width: 55%">55%</div>
                    </div>
                </div>
            </div>
        </header>
    </div>
    <div class="app__body">
        <div class="container">
            <main class="screen spannungsfelder">
                <h1>
                    Spannungsfelder
                </h1>
                <p>
                    Spannungsfelder: Diese Kräfte beschreiben deinen Einfluss auf eure
                    Teamdynamik:
                </p>
                <ul>
                    <li>
                        Weiss deutet auf Spannungsfreiheit hin.
                    </li>
                    <li>
                        Werte über 16 deuten auf Spannungen im Team hin.
                    </li>
                    <li>
                        Bei roten Werten liegt deine Selbstwahrnehmung ausserhalb der
                        psychologischen Sicherheitszone.
                    </li>
                    <li>
                        Bei gelben Werten liegt die Fremdwahrnehmung ausserhalb der
                        psychologischen Sicherheitszone.
                    </li>
                    <li>
                        Bei schwarzen Werten liegen deine Selbst- und die Fremdwahrnehmung ausserhalb der
                        psychologischen Sicherheitszone eures Teams.
                    </li>
                </ul>

                <div id="graph-slider" class="swiper-container">
                    <div class="swiper-wrapper">
                    </div>
                    <div class="swiper-button-prev"></div>
                    <div class="swiper-button-next"></div>
                    <div class="swiper-pagination"></div>
                </div>
                <div class="custom-graph1"></div>
                <div class="custom-graph2"></div>
                <div id="rang-slider" class="swiper-container">
                    <div class="swiper-wrapper">
                    </div>
                </div>
                <div class="custom-graph-info">
                    <div class="custom-graph-info__item small" data-text="Others">
                        {{ others }}
                    </div>
                    <div class="custom-graph-info__item base" data-text="Self">
                        {{ himself }}
                    </div>
                    <div class="custom-graph-info__item large" data-text="Tension">
                        {{ tension }}
                    </div>
                </div>
                <p>
                    Grün eingefärbt siehst du die
                    psychologischen Sicherheitszonen deines Teams. Erkennst du, ob dein
                    Beitrag zur Teamdynamik eher als ausgleichend oder spaltend wahrgenommen
                    wird? Wie erklärst du die Unterschiede in deiner Selbstwahrnehmung und der
                    Fremdwahrnehmung durch das Team? Möchtest du erraten, wie du von jedem
                    Teammitglied eingeschätzt wirst? Dann spiel weiter!
                </p>
                <div class="center">
                    <a href="/preview-2/" class="button" id="button">
                        Weiterspielen
                    </a>
                </div>

            </main>
        </div>
    </div>
</div>
<script src="/static/js/AppRange.js"></script>
<script src="/static/js/AppGraph.js"></script>
<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
<script>
    var json_list = {{ json_list|safe }};
    let curentUser = "{{ user }}";
    // function deal_json(json_list, num){
    //     var new_json_list = [];
    //     var uu = 0;
    //     while (uu < json_list.length){
    //         if (uu == num){
    //             new_json_list.push(json_list[uu]);
    //         }else{
    //             var temp = {
    //                 statusSide:json_list[uu]['statusSide'],
    //                 value: json_list[uu]['value'],
    //             };
    //             new_json_list.push(temp);
    //         }
    //         uu += 1;
    //     }
    //     return new_json_list;
    // }

    //console.log(json_list);
    //console.log(deal_json(json_list, 0));

    // function format_data(json_list){
    //     var num = json_list.length;
    //     var result = [];
    //     var uu = 0;
    //     while (uu < num){
    //         var temp = {
    //             range: [1, 99],
    //             labelRange: ['Low', 'High'],
    //             data: deal_json(json_list, uu)
    //         };
    //         result.push(temp);
    //         uu += 1;
    //     }
    //     return result;
    // }


    function traitArray(json_list) {
      let arr = new Set();
      json_list.forEach((item) => {
        arr.add(item.value)
      })
      let result = Array.from(arr);
      return(result)
    }

    function arrayForGraph(json) {
        let arr = [];
        for (let item of json) {
            tempObj = {};
            if(item.name == curentUser) {
                tempObj['name'] = item.target_user;
                tempObj['avatar'] = item.target_user_avatar;
                tempObj['statusSide'] = item.statusSide;
                tempObj['value'] = item.value;
                tempObj['status'] = item.statusSide.toString();
                arr.push(tempObj);
            }
        }
        return arr
    }

    function arrayGraphModifier(item) {
      const {name, avatar, status, statusSide, value} = item;
      if(item.name == "{{user}}") {
        return(
          {'name':name,
          'avatar':avatar,
          'status':status,
          'statusSide':statusSide,
          'value':value}
        )
      }
      else {
        return(
          {'status':status,
          'statusSide':statusSide,
          'value':value}
        )
      }
    }

    function safezoneData(value) {
        let arr = [];
        for (let item of json_list) {
            if (item.value == value) {
                arr.push(item.statusSide);
            }
        }
        return arr

    }

    let dataForGraph = () => {
      let result = [];
      for (let value of traitArray(json_list)) {
        dataRaw = arrayForGraph(json_list).filter(jso => jso.value == value);
        datas = dataRaw.map(arrayGraphModifier);
        temp = {
      		'data':datas,
      		'labelRange':['low','high'],
      		'range':[1,99],
      	}
        result.push(temp);
      }
      return(result)
    }

    let dataForRange = () => {
      let result = [];
      for (let value of traitArray(json_list)) {
        datas = arrayForGraph(json_list).filter(jso => jso.value == value);
        let others = 0;
        let self = 0;
        datas.forEach((item, i) => {
          if(item.name != '{{user}}') {
            others += item.statusSide;
          }
          else {
            self = item.statusSide;
          }
        });
        others = Math.round(others/(datas.length-1));
        temp = {
          'value':value,
          'self':self,
          'others':others,
          'tension':self - others,
        };
        result.push(temp);
      }
      return(result)
    }


    const isMobile = () => window.innerWidth <= 1200;
    // const data = format_data(json_list);


    const wrapper = document.querySelector('#graph-slider .swiper-wrapper');
    let htmlWrappers = ``;

    dataForGraph().forEach((item, i) => {
        htmlWrappers += `<div class="swiper-slide slide-${i}"></div>`;
    });

    wrapper.innerHTML = htmlWrappers;

    let newapp = new AppRange({
        container: '#rang-slider',
        innerWrapper: isMobile() ? 'rang swiper-wrapper' : 'rang',
        // data: data.map(({data}) => {
        //     const dataSort = data.filter(el => el.name);
        //     const {name, avatar, statusSide, value} = dataSort[0];
        //     return {
        //         name,
        //         avatar,
        //         statusSide,
        //         value,
        //     }
        // }),
        data:dataForRange(),
        callback(item, i) {
            if (!isMobile()) {
                const itemClickable = document.querySelectorAll('#graph-slider .swiper-pagination-bullet');
                itemClickable[i].click();
                item.classList.add('active');
                bottomValues = document.querySelector('.custom-graph-info').children
                bottomValues[0].innerText = this.data[i].others;
                bottomValues[1].innerText = this.data[i].self;
                bottomValues[2].innerText = this.data[i].tension;
            }
        },
        update(item) {
            if (!isMobile()) {
                item.classList.remove('active');
            }
        },
        loadEnd() {
            if (isMobile()) {
                new Swiper(this.container, {
                    slidesPerView: 6,
                    spaceBetween: 0,
                    centeredSlides: true,
                    grabCursor: true,
                    loop: true,
                    breakpoints: {
                        768: {
                            slidesPerView: 3,
                            spaceBetween: 0,
                        },
                        480: {
                            slidesPerView: 2,
                            spaceBetween: 0,
                        },
                        320: {
                            slidesPerView: 1,
                            spaceBetween: 0,
                        },
                    },
                    navigation: {
                        nextEl: '.rang-button-next',
                        prevEl: '.rang-button-prev',
                    },
                    on: {
                        slideChange(a, b, c) {
                            const index = a.realIndex;
                            const itemClickable = document.querySelectorAll('#graph-slider .swiper-pagination-bullet');
                            itemClickable[index].click();
                        }
                    }
                });
            }
        }
    });

    dataForGraph().forEach((item, i) => {
        appgraph = new AppGraph({
            container: `.swiper-slide.slide-${i}`,
            range: item.range,
            labelRange: item.labelRange,
            mobile: 1200,
            statistic: true,
            data: item.data,
            safezoneData: safezoneData(item.data[0].value),
            graphNumber: i,
        });
        console.log(appgraph.safeLow, appgraph.safeHigh);
        var blue_range = appgraph.high - appgraph.low;
        let halfAvatar = document.querySelector('div.custom-graph__item-avatar').clientHeight/2;

        //console.log(this.data);
        // if (window.innerWidth <= appgraph.mobile) {
        //   css_change(`.statistic .custom-graph__items:before{
        //     left:calc((100% - ${halfAvatar}px) * ${low/100} + ${halfAvatar}px);
        //     width:calc((100% - ${halfAvatar}px) * ${blue_range/100});
        //     }`);
        // } else {
        //     css_change(`.statistic .custom-graph__items:before{
        //       bottom:calc((100% - ${halfAvatar}px) * ${low/100} + ${halfAvatar}px);
        //       height:calc((100% - ${halfAvatar}px) * ${blue_range/100});
        //       }`);
        // }

        // function css_change(t, s) {
        //     s = document.createElement('style');
        //     s.innerText = `.slide-0 .statistic .custom-graph__items:before{
        //         left:calc((100% - ${halfAvatar}px) * ${appgraph.low/100} + ${halfAvatar}px);
        //         width:calc((100% - ${halfAvatar}px) * ${blue_range/100});
        //         }`;
        //     document.body.appendChild(s);
        // };
        
    });

    new Swiper('#graph-slider', {
        grabCursor: true,
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        pagination: {
            el: '.swiper-pagination',
            clickable: true
        }
    });

    // function graphUnifier(data) {
    //   // compile all graph in one with all players active
    //   let arr = [];
    //   for(let graph of data) {
    //     let user = graph.data.filter(item => item.name)[0];
    //     arr.push(user);
    //   }
    //   return(arr)
    // }
    //
    // unifiedData = graphUnifier(data);

    function cardsPainting(unifiedData) {
      let collection = document.querySelectorAll('.rang__item');
      collection.forEach((item, i) => {
        let low = document.querySelector(`.slide-${i}`).children[0].getAttribute('low')
        let high = document.querySelector(`.slide-${i}`).children[0].getAttribute('high')
        let selfInSafe = unifiedData[i].self>low && unifiedData[i].self<high;
        let othersInSafe = unifiedData[i].others>low && unifiedData[i].others<high;
        if (selfInSafe && othersInSafe) {item.classList.add('white__card');}
        if (selfInSafe && !othersInSafe) { item.classList.add('yellow__card');}
        if (!selfInSafe && othersInSafe) { item.classList.add('red__card');}
        if (!selfInSafe && !othersInSafe) { item.classList.add('black__card');}
      });

    }
    cardsPainting(dataForRange());

    // var css_change = function(t,s){
    //     s = document.createElement('style');
    //     s.innerText = t;
    //     document.body.appendChild(s);
    // };


</script>
<style>
    
</style>
</body>
</html>
