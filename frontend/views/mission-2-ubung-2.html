{% load i18n %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" href="/static/images/favicon.ico"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1"/>
    <meta name="theme-color" content="#51ceec"/>
    <meta name="description" content="ARK"/>
    <title>Development-FEEDBACK</title>
    <link rel="stylesheet" href="/static/css/app.css">
    <link rel="stylesheet" href="/static/css/feedback.css">
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">

    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
</head>
<body>
  {% get_current_language as LANGUAGE_CODE %}
<div class="app">
    <div class="app__head">
        <header class="header-main container">
            <div class="header-main__title">
                <a class="icon arks-logo-clickable" href="https://info.arks.ch/" target="_blank" rel="noopener noreferrer">
                <span class="icon-logo"></span>
                <span>ARKS</span>
                <span id="arks-logo-tooltip-icon" class="tooltip-icon" style="display: none;">{% trans "Info zu safecircles.ch" %}</span>
                </a>
            </div>
            <div class="header-main__user">
                <div class="user">
                    <div class="user__subtitle">
                        {{game.name}}
                    </div>
                    <img src="{{user.avatar}}" alt="{{user.name}}" aria-label="{% trans 'Benutzer Avatar' %}">
                    <div class="user__title">
                        {{user.name}}
                    </div>
                </div>
            </div>
            <div class="header-main__progress">
                <div class="progress">
                    <label>VOICE</label>
                    <div class="progress__bar">
                        <div class="progress__bar-fill">100%</div>
                    </div>
                </div>
            </div>
        </header>
    </div>
    <div class="app__body" id='app-1'>
        <div class="container"
        v-loading="loading"
        element-loading-text="Waiting for your teammates"
        element-loading-background="rgba(0, 0, 0, 0.8)">
            <main class="screen feedback">
                <h1>
                    {% trans "Bitte gib anonymes Feedback" %}
                </h1>
                <div class="feedback__data">
                    <p class="feedback-intro-text">
                        {% trans "Schau dir zuerst das Spannungsprofil deines Feedbacknehmers rechts an. Und beantworte dann die drei Fragen für ein offenes, lösungsorientiertes und anonymes Feedback..." %}
                    </p>
                    <div class="fields-fill__wrapper"></div>
                </div>
                <div class="feedback__users">
                    <p class="bold">
                        {% trans "Spannungsfelder von" %}
                        <span id="feedback-target-name"></span>
                    </p>
                <form id="form_" action="#" method="POST" class="form">
                {% csrf_token %}
                <div class="feedback-legend-box">

                    <p class="feedback-legend-green">
                        {% trans "Spannungs-Werte unter 16 = deuten auf Spannungsfreiheit mit dem Team hin" %}
                    </p>
                    <p class="feedback-legend-text">
                        {% trans "Positives Vorzeichen = zu positive Selbstwahrnehmung" %}<br>
                        {% trans "Negatives Vorzeichen = zu kritische Selbstwahrnehmung" %}
                    </p>
                </div>
                    <div class="center feedback-actions">
                        <input id="data" type="hidden" name="data" value=""/>
                        <button type="button" class="button button-primary" id="button" @click="check_submit()" aria-label="{% trans 'Weiter' %}">
                            <span class="button-text">{% trans "Weiter" %}</span>
                            <span class="button-arrow">→</span>
                        </button>
                        <div class="copyright-footer">
                            <a href="https://github.com/joe-the-ark/ark" target="_blank" rel="noopener noreferrer">{% trans "ARKS is published under a GPLv3" %}</a> {% trans "license by" %} 
                            <a href="https://www.linkedin.com/in/dr-joe-maier/" target="_blank" rel="noopener noreferrer">{% trans "Dr. Joe Maier" %}</a>.
                        </div>
                    </div>
                </form>
            </main>
        </div>
    </div>
</div>

<!-- <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script> -->
<script src="/static/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="/static/js/AppRange.js"></script>
<script src="/static/js/AppFeedback.js"></script>
<script src="/static/jquery-3.5.1.min.js"></script>
<script src="/static/axios.min.js"></script>
<script src="/static/js/utils.js"></script>
<script src="/static/js/waitingRoomHelpers.js"></script>
<script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.min.js"></script>
<script src="https://unpkg.com/tippy.js@6/dist/tippy-bundle.umd.js"></script>
<script>


    const langCode = '{{ LANGUAGE_CODE }}';
    const rawJsonAll = {{ json_list_all|safe }};
    const jsonAll = Array.isArray(rawJsonAll) ? rawJsonAll.map(item => Object.assign({}, item)) : [];

    const translateTerm = (dictionary) => {
        if (!dictionary || typeof dictionary !== 'object') {
            return '';
        }
        return dictionary[langCode] || dictionary.en || Object.values(dictionary)[0] || '';
    };

    jsonAll.forEach((item) => {
        const power = translateTerm(item.ubung1_power_i18n);
        const drainer = translateTerm(item.ubung3_drainer_i18n);
        item.value = `${power} ${drainer}`.trim();
    });

    const rawMemberList = {{ json_list|safe }};
    const member_list = Array.isArray(rawMemberList) ? rawMemberList.filter(item => item && item.name) : [];

    const MIN_WORD_COUNT = 25;
    const WORD_LABEL = "{{ _('words')|escapejs }}";
    const WORD_COUNT_ERROR = "{{ _('Please write at least 25 words in every feedback area.')|escapejs }}";

    const countWords = (value) => {
        if (!value) {
            return 0;
        }
        return value
            .trim()
            .split(/\s+/)
            .filter(Boolean)
            .length;
    };

    const formatWordCountText = (count) => {
        const suffix = WORD_LABEL ? ` ${WORD_LABEL}` : '';
        return `${count} / ${MIN_WORD_COUNT}${suffix}`;
    };

    const updateWordIndicator = (textarea) => {
        if (!textarea) {
            return;
        }
        const fieldWrapper = textarea.closest('.fields-fill__field');
        const indicator = fieldWrapper ? fieldWrapper.querySelector('[data-word-indicator]') : null;
        if (!indicator) {
            return;
        }
        const wordCount = countWords(textarea.value);
        const textNode = indicator.querySelector('.word-count__text');
        if (textNode) {
            textNode.textContent = formatWordCountText(wordCount);
        }
        indicator.classList.toggle('word-count--valid', wordCount >= MIN_WORD_COUNT);
        indicator.classList.toggle('word-count--invalid', wordCount < MIN_WORD_COUNT);
    };

    const bindWordCounters = () => {
        const textareas = document.querySelectorAll('[data-word-input]');
        textareas.forEach((textarea) => {
            if (!textarea.dataset.wordCountBound) {
                textarea.addEventListener('input', () => updateWordIndicator(textarea));
                textarea.dataset.wordCountBound = 'true';
            }
            updateWordIndicator(textarea);
        });
    };

    function format_list(member_list){
        var num = member_list.length;
        var uu = 0;
        var result = [];
        while (uu < num){
            var temp = {
                id: member_list[uu]['id'],
                name: member_list[uu]['name'],
                avatar: member_list[uu]['avatar'],
                statusSide: member_list[uu]['statusSide'],
                feedback: [
                    {
                        title: "{% trans 'WEITER SO: Besonders schätze ich deinen Beitrag zum gelingenden Zusammenspiel im Team, wenn WIR...' %}",
                        text: ' '
                    },
                    {
                        title: "{% trans 'WUNSCH: Du könntest zu mehr psychologischen Sicherheit im Team beitragen, indem DU...' %}",
                        text: ' '
                    },
                    {
                        title: "{% trans 'UNTERSTÜTZUNG: Ich werde dich unterstützen unser Team psychologisch sicherer zu machen, indem ICH...' %}",
                        text: ' '
                    }
                ],
            };
            result.push(temp);
            uu += 1;
        }
        return result;
    }


    const getNameArray = (source) => {
        if (typeof nameArray === 'function') {
            return nameArray(source);
        }
        if (!Array.isArray(source)) {
            return [];
        }
        return source.map(item => item && item.name).filter(Boolean);
    };

    function arrayForFeedback(json, names) {
        let arr = []
        for (let name of names) {
            for (let item of json) {
                if(item.name == name) {
                    arr.push({
                        'name':item.name,
                        'id':item.id,
                        'avatar': item.avatar,
                        'feedback': [
                            {
                                title: "{% trans 'WEITER SO: Besonders schätze ich deinen Beitrag zum gelingenden Zusammenspiel im Team, wenn WIR...' %}",
                                text: ' '
                            },
                            {
                                title: "{% trans 'WUNSCH: Du könntest zu mehr psychologischen Sicherheit im Team beitragen, indem DU...' %}",
                                text: ' '
                            },
                            {
                                title: "{% trans 'UNTERSTÜTZUNG: Ich werde dich unterstützen unser Team psychologisch sicherer zu machen, indem ICH...' %}",
                                text: ' '
                            }
                        ],
                    });
                    break
                }
            }
        }
        return arr
    }



    const dataFeedback = arrayForFeedback(jsonAll, getNameArray(jsonAll));



    var data = format_list(member_list);






    const appfeed = new AppFeedback({
        container: '.fields-fill__wrapper',
        data: dataFeedback,
        loadEnd(bodyItems) {
            const fieldsBody = document.querySelector('.fields-fill__body');
            if (fieldsBody && fieldsBody.children.length) {
                fieldsBody.children[0].classList.add('active');
            }
            const targetName = document.getElementById('feedback-target-name');
            if (targetName && dataFeedback.length) {
                targetName.innerText = dataFeedback[0].name;
            }
            const firstRange = document.querySelector('.rang-wrapper');
            if (firstRange) {
                firstRange.classList.add('active');
            }
            const firstTextarea = document.querySelector('.fields-fill__field-wrapper textarea') || document.querySelector('textarea');
            if (firstTextarea) {
                setTimeout(() => { firstTextarea.focus(); }, 500);
            }
            bindWordCounters();
        }
    });


    function refresh(){
        if (!appfeed || !appfeed.data) {
            return;
        }
        const st = JSON.stringify(appfeed.data);
        $('#data').val(st);
    }
    setInterval(refresh, 500);


    const app1 = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app-1',
        data(){
            return{
                loading: false,
            }
        },
        created(){
            const loading_ = '{{ loading }}'
            if (loading_ === '0'){
                this.loading = false
            }else{
                this.loading = true
            }
        },
        methods:{
            check_submit(){
                if (formValidator(containers) === true){
                    const form_submit = document.getElementById('form_')
                    form_submit.submit()
                    return
                }else{
                    this.$message({
                        showClose: true,
                        message: WORD_COUNT_ERROR,
                        type: 'error',
                        center: true
                    })
                }
            }
        }
    })


        //dropdown
    $('.fields-fill__connect').click(function () {
        $(this).attr('tabindex', 1).focus();
        $(this).toggleClass('active');
        $(this).find('.dropdown-menu').slideToggle(300);
    });
    $('.fields-fill__connect').focusout(function () {
        $(this).removeClass('active');
        $(this).find('.dropdown-menu').slideUp(300);
    });
    $('.fields-fill__connect .dropdown-menu li').click(function () {
        let choosenUser = $(this).text();
        let index = $(this).index();
        let bodyItems = document.querySelectorAll('.fields-fill__field-wrapper');
        let rang = document.querySelectorAll('.rang-wrapper');
        let selected = document.querySelector('.fields-fill__connect');
        //Change user
        selected.querySelector('img').src = appfeed.data[index].avatar;
        selected.querySelector('.fields-fill__connect-name').innerText = choosenUser;
        //Change feedback forms.
        bodyItems.forEach((item, i) => {
            item.classList.remove('active');
        });
        bodyItems[index].classList.add('active');
        //Change cards.
        rang.forEach((item,i) => {
            item.classList.remove('active');
        })
        rang[index].classList.add('active');
        //Change name above cards.
        const targetName = document.getElementById('feedback-target-name');
        if (targetName) {
            targetName.innerText = dataFeedback[index].name;
        }
        
        setTimeout(() => {
            const activeWrapper = bodyItems[index];
            if (activeWrapper) {
                const firstTextarea = activeWrapper.querySelector('textarea');
                if (firstTextarea) {
                    firstTextarea.focus();
                }
                const wrapperTextareas = activeWrapper.querySelectorAll('textarea');
                wrapperTextareas.forEach((field) => updateWordIndicator(field));
            }
        }, 500);
    });

    const containers = document.querySelectorAll('.fields-fill__field-wrapper');

    function formValidator(containers) {
        console.log(containers)
        const menu = document.querySelector('#menu');
        let result = true; 
        outer: for(let [c, cont] of containers.entries()){
         
            let textarea = cont.querySelectorAll('textarea');
            for(let [i, item] of textarea.entries()) {
                const wordCount = countWords(item.value);
                if(wordCount < MIN_WORD_COUNT) {
                    console.log(c, i, "bad form");
                    if (menu && menu.children[c]) {
                    menu.children[c].click();
                    menu.children[c].click();
                    }
                    setTimeout(() => {item.focus();}, 1000);
                    let tooltip = tippy(item);
                    tooltip.setProps({trigger: 'manual'});
                    tooltip.setContent(WORD_COUNT_ERROR);
                    tooltip.show(); 
                    updateWordIndicator(item);
                    result = false;
                    return result
                    break outer;
                    
                }


                
            };
        };
        return result;
    } 

    function cardsPlacing(jsonAll) {
        const names = getNameArray(jsonAll);
        const divCollection = document.createDocumentFragment()
        for(let name of names) {
            let div = document.createElement('div');
            div.classList.add('rang-wrapper');
            div.classList.add(`s${name}`);
            divCollection.append(div);



        }
        const feedbackUsers = document.querySelector('.feedback__users');
        if (feedbackUsers) {
            const form = feedbackUsers.querySelector('form');
            if (form) {
                form.before(divCollection);
            } else {
                feedbackUsers.append(divCollection);
            }
        }
        if (typeof AppRange !== 'function' || typeof dataForRange !== 'function') {
            return;
        }
        for(let name of names){
            const data = dataForRange(jsonAll, name) || [];
            if (!Array.isArray(data) || !data.length) {
                continue;
            }
            new AppRange({
                container: `.rang-wrapper.s${name}`,
                data: data,
                innerWrapper: 'rang min',
                load(wrapper) {
                    wrapper[0].classList.add('min')
                }
            });

            const selectors = document.querySelectorAll(`.rang-wrapper.s${name} .rang__item`);
            if (typeof cardsPainting === 'function' && selectors.length) {
            cardsPainting(data, selectors);
            // Initialize tooltips after cards are painted
            setTimeout(initColorCardTooltips, 200);
            }
        }
    }
    cardsPlacing(jsonAll);
    bindWordCounters();
    
    // Initialize tooltips for color cards (rang__item-wrapper)
    function initColorCardTooltips() {
        // Get translated tooltip texts from Django
        const tooltipTexts = {
            white: "{% trans 'Grün = Spannungsfreiheit'|escapejs %}<br>{% trans 'Spannungs-Werte unter 16 = deuten auf Spannungsfreiheit mit dem Team hin'|escapejs %}",
            yellow: "{% trans 'Gelb = die Wahrnehmung deines Beitrags zur inneren Sicherheit der anderen liegt außerhalb der Safe-Base'|escapejs %}",
            red: "{% trans 'Rot = deine Selbstwahrnehmung liegt ausserhalb der Safe-Base'|escapejs %}",
            black: "{% trans 'Schwarz = die Selbst- und die Fremdwahrnehmung deines Beitrags zur inneren Sicherheit liegen ausserhalb der Safe-Base'|escapejs %}"
        };
        
        // Find all rang__item elements
        const rangItems = document.querySelectorAll('.rang__item');
        
        rangItems.forEach((item, index) => {
            const wrapper = item.querySelector('.rang__item-wrapper');
            if (!wrapper) return;
            
            // Determine which color card class is present
            let tooltipText = '';
            if (item.classList.contains('white__card')) {
                tooltipText = tooltipTexts.white;
            } else if (item.classList.contains('yellow__card')) {
                tooltipText = tooltipTexts.yellow;
            } else if (item.classList.contains('red__card')) {
                tooltipText = tooltipTexts.red;
            } else if (item.classList.contains('black__card')) {
                tooltipText = tooltipTexts.black;
            }
            
            // Only add tooltip if we have text and haven't initialized it yet
            if (tooltipText && tooltipText.trim() !== '' && !wrapper.hasAttribute('data-tippy-initialized')) {
                // Remove existing tooltip if any
                if (wrapper._tippy) {
                    wrapper._tippy.destroy();
                }
                
                try {
                    if (typeof tippy !== 'undefined') {
                        tippy(wrapper, {
                            content: tooltipText,
                            placement: 'top',
                            theme: 'light',
                            delay: [200, 0],
                            allowHTML: true,
                            interactive: false,
                            trigger: 'mouseenter focus',
                        });
                        wrapper.setAttribute('data-tippy-initialized', 'true');
                    }
                } catch (e) {
                    console.error('Error initializing color card tooltip:', e);
                }
            }
        });
    }
    
    // Initialize tooltips after cards are painted
    // Use MutationObserver to detect when cards are added/updated
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length || mutation.type === 'attributes') {
                setTimeout(initColorCardTooltips, 100);
            }
        });
    });
    
    // Observe the feedback__users container for changes
    const feedbackUsersContainer = document.querySelector('.feedback__users');
    if (feedbackUsersContainer) {
        observer.observe(feedbackUsersContainer, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['class']
        });
    }
    
    // Initialize tooltips immediately and after a delay to catch dynamically added cards
    setTimeout(initColorCardTooltips, 500);
    setTimeout(initColorCardTooltips, 1500);


    function sleep(time) {
        return new Promise((resolve) => setTimeout(resolve, time));
    }

    async function check_finish(){
        const reminderMessage = "{% trans 'Bleibt dran – klickt auf Weiter, wenn ihr mit dem Feedback fertig seid.' %}";
        const reminder = WaitingRoomHelpers.createReminder({
            message: reminderMessage,
            firstDelayMs: 120000,
            repeatDelayMs: 210000,
            maxCount: 2
        });

        while (1){
            await sleep(12000).then(() => {
                if (app1.loading === true){
                    var data_ = {'link': '{{game.link}}'}
                    axios
                        .post(`/api/last_stop_check/`, data_)
                        .then(function(response){
                            var result = response.data.result
                            if (result === 1){
                                reminder.stop();
                                window.location.href = '/assessment/'
                            }else{
                                reminder.touch();
                            }
                        })
                        .catch(function(error){
                            console.log(error)
                        })
                }
            })
        }
    }

    //check_finish()

    // ARKS Logo Tooltip
    function initARKSLogoTooltip() {
        const arksLogoContainer = document.querySelector('.header-main__title .arks-logo-clickable');
        const arksLogoTooltipIcon = document.getElementById('arks-logo-tooltip-icon');
        
        if (arksLogoContainer && arksLogoTooltipIcon) {
            arksLogoContainer.addEventListener('mouseenter', function() {
                arksLogoTooltipIcon.style.display = 'inline-flex';
            });
            
            arksLogoContainer.addEventListener('mouseleave', function() {
                arksLogoTooltipIcon.style.display = 'none';
            });
            
            if (typeof tippy !== 'undefined') {
                tippy(arksLogoTooltipIcon, {
                    placement: 'bottom',
                    arrow: true,
                    animation: 'fade'
                });
            }
        }
    }
    
    // Initialize ARKS logo tooltip when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initARKSLogoTooltip);
    } else {
        initARKSLogoTooltip();
    }

</script>
<script src="/static/js/update_fix.js"></script>
</body>
</html>
