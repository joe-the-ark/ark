{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" href="/static/images/favicon.ico"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1"/>
    <meta name="theme-color" content="#51ceec"/>
    <meta name="description" content="ARK"/>
    <title>Development-FEEDBACK</title>
    <link rel="stylesheet" href="/static/css/app.css">
    <link rel="stylesheet" href="/static/css/feedback.css">
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">

    <script src="/static/vue.js"></script>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- 引入组件库 -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
</head>
<body>
<div class="app">
    <div class="app__head">
        <header class="header-main container">
            <div class="header-main__title">
                <span class="icon-logo"></span>
                <span>ARK</span>
            </div>
            <div class="header-main__user">
                <div class="user">
                    <div class="user__subtitle">
                        {{game.name}}
                    </div>
                    <img src="{{user.avatar}}" alt="">
                    <div class="user__title">
                        {{user.name}}
                    </div>
                </div>
            </div>
            <div class="header-main__progress">
                <div class="progress">
                    <label>Mission 2</label>
                    <div class="progress__bar">
                        <div style="width: 80%">80%</div>
                    </div>
                </div>
            </div>
        </header>
    </div>
    <div class="app__body" id='app-1'>
        <div class="container"
        v-loading="loading"
        element-loading-text="Waiting for your teammates"
        element-loading-background="rgba(0, 0, 0, 0.8)">
            <main class="screen feedback">
                <h1>
                    Letzte Aufgabe: Anonymes Feedback
                </h1>
                <div class="feedback__data">
                    <p>
                        Was ist der Beitrag vom Mitspieler zur Psychologischen
                        Sicherheit im Team? Schau dir zuerst das Spannungsprofil deines
                        Feedbacknehmers rechts an. Und Beantworte dann die drei Fragen für ein
                        offenes, lösungsorientiertes und anonymes Feedback. Geh ein Risiko ein und
                        schreib mit offenem Herzen...
                    </p>
                    <div class="fields-fill__wrapper"></div>
                </div>
                <div class="feedback__users">
                    <p class="bold">
                        Spannungsfelder von
                        <span>
                            Constantin Constantinopol
                        </span>
                    </p>
                <form id="form_" action="#" method="POST" class="form">
                {% csrf_token %}
                    <p>
                        <b>Weiss</b> = Spannungsfreiheit<br>
                            <b>Rot</b> = Selbstwahrnehmung außerhalb Safe Zone<br>
                            <b>Gelb</b> = Wahrnehmung der Anderen außerhalb Safe Zone<br>
                            <b>Schwarz</b> = Selbst- & Fremdwahrnehmung ausserhalb Safe Zone
                    </p>
                    <div class="center">
                        <input id="data" type="hidden" name="data" value=""/>
                        <button type="button" id="button" @click="check_submit()">
                            Weiterspielen
                        </button>
                        <button id="test"  type="button" style="position: absolute; visibility: hidden;">Weiterspielen</button>
                    </div>
                </form>
            </main>
        </div>
    </div>
</div>

<!-- <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script> -->
<script src="/static/js/AppRange.js"></script>
<script src="/static/js/AppFeedback.js"></script>
<script src="/static/jquery-3.5.1.min.js"></script>
<script src="/static/axios.min.js"></script>
<script src="/static/js/utils.js"></script>
<script src="/static/popper.min.js"></script>
<script src="/static/tippy-bundle.umd.min.js"></script>
<script>


    const {log} = console;
    let userCurrent = "{{ user }}";
    let jsonAll = {{ json_list_all|safe }};
    
    // let dataCur = "{{ json_list }}";
    var member_list = {{ json_list|safe }}.filter(item => item.name);

    function format_list(member_list){
        var num = member_list.length;
        var uu = 0;
        var result = [];
        while (uu < num){
            var temp = {
                id: member_list[uu]['id'],
                name: member_list[uu]['name'],
                avatar: member_list[uu]['avatar'],
                statusSide: member_list[uu]['statusSide'],
                feedback: [
                    {
                        title: 'MEHR davon: Ich schätze deinen Beitrag zum gelingenden Zusammenspiel im Team…',
                        text: ''
                    },
                    {
                        title: 'ÄNDERN: du könntest zur psychologischen Sicherheit im Team beitragen, in dem...',
                        text: ''
                    },
                    {
                        title: 'FRAGEZEICHEN: ich wollte dich schon immer mal fragen…',
                        text: ''
                    }
                ],
            };
            result.push(temp);
            uu += 1;
        }
        return result;
    }




    let dataFeedback = arrayForFeedback(jsonAll, nameArray(jsonAll));
    let curentUser = dataFeedback[0].name;



    var data = format_list(member_list);





    let appfeed = new AppFeedback({
        container: '.fields-fill__wrapper',
        data: dataFeedback,
        loadEnd(bodyItems) {
            document.querySelector('.fields-fill__body').children[0].classList.add('active');
            document.querySelector('.feedback__users .bold span').innerText = dataFeedback[0].name;
            document.querySelector('.rang-wrapper').classList.add('active');
            setTimeout(() => {document.querySelector('textarea').focus();}, 500)

        }
    });


    function refresh(){
        var st = JSON.stringify(appfeed.data);
        $('#data').val(st);
    }
    setInterval("refresh()", 100);


    var app1 = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app-1',
        data(){
            return{
                loading: false,
            }
        },
        created(){
            var loading_ = '{{ loading }}'
            if (loading_ === '0'){
                this.loading = false
            }else{
                this.loading = true
            }
        },
        methods:{
            check_submit(){
                if (formValidator(containers) === true){
                    var form_submit = document.getElementById('form_')
                    form_submit.submit()
                    return
                }else{
                    this.$message({
                        showClose: true,
                        message: 'Please write more than 25 characters in every feedback area.',
                        type: 'error',
                        center: true
                    })
                }
            }
        }
    })


        //dropdown
    $('.fields-fill__connect').click(function () {
        $(this).attr('tabindex', 1).focus();
        $(this).toggleClass('active');
        $(this).find('.dropdown-menu').slideToggle(300);
    });
    $('.fields-fill__connect').focusout(function () {
        $(this).removeClass('active');
        $(this).find('.dropdown-menu').slideUp(300);
    });
    $('.fields-fill__connect .dropdown-menu li').click(function () {
        let choosenUser = $(this).text();
        let index = $(this).index();
        let bodyItems = document.querySelectorAll('.fields-fill__field-wrapper');
        let rang = document.querySelectorAll('.rang-wrapper');
        let selected = document.querySelector('.fields-fill__connect');
        //Change user
        selected.querySelector('img').src = appfeed.data[index].avatar;
        selected.querySelector('.fields-fill__connect-name').innerText = choosenUser;
        //Change feedback forms.
        bodyItems.forEach((item, i) => {
            item.classList.remove('active');
        });
        bodyItems[index].classList.add('active');
        //Change cards.
        rang.forEach((item,i) => {
            item.classList.remove('active');
        })
        rang[index].classList.add('active');
        //Change name above cards.
        document.querySelector('.feedback__users .bold span').innerText = dataFeedback[index].name;
        
        setTimeout(() => {bodyItems[index].querySelector('textarea').focus();}, 500);
    });

    let containers = document.querySelectorAll('.fields-fill__field-wrapper');

    function formValidator(containers) {
        console.log(containers)
        let menu = document.querySelector('#menu');
        let result = true; 
        outer: for(let [c, cont] of containers.entries()){
         
            let textarea = cont.querySelectorAll('textarea');
            for(let [i, item] of textarea.entries()) {
                if(item.textLength < 25) {
                    console.log(c, i, "bad form");
                    menu.children[c].click();
                    menu.children[c].click();
                    setTimeout(() => {item.focus();}, 1000);
                    let tooltip = tippy(item);
                    tooltip.setProps({trigger: 'manual'});
                    tooltip.setContent('Must be more than 25 characters');
                    tooltip.show(); 
                    result = false;
                    return result
                    break outer;
                    
                }


                
            };
        };
        return result;
    } 

    function cardsPlacing(jsonAll) {
        divCollection = document.createDocumentFragment()
        for(let name of nameArray(jsonAll)) {
            let div = document.createElement('div');
            div.classList.add('rang-wrapper');
            div.classList.add(`${name}`);
            divCollection.append(div);



        }
        document.querySelector('.feedback__users form').before(divCollection);
        for(let name of nameArray(jsonAll)){
            let data = dataForRange(jsonAll, name);
            let range = new AppRange({
                container: `.rang-wrapper.${name}`,
                data: data,
                innerWrapper: 'rang min',
                load(wrapper) {
                    wrapper[0].classList.add('min')
                }
            });

            
            let selectors = document.querySelectorAll(`.rang-wrapper.${name} .rang__item`);
            cardsPainting(data, selectors);
        }
    }
    cardsPlacing(jsonAll);


    function sleep (time) {
        return new Promise((resolve) => setTimeout(resolve, time));
    }

    async function check_finish(){
        var uu = 0
        while (1){
            if (uu%10 === 9){
                alert("Connection time out. If you want to continue waiting, please click the button.")
            }
            await sleep(5000).then(() => {
                if (app1.loading === true){
                    var data_ = {'link': '{{game.link}}'}
                    axios
                        .post(`/api/last_stop_check/`, data_)
                        .then(function(response){
                            var result = response.data.result
                            if (result === 1){
                                window.location.href = '/assessment/'
                            }else{
                                uu += 1
                                console.log(uu)
                            }
                        })
                        .catch(function(error){
                            console.log(error)
                        })
                }
            })
        }
    }


 

</script>
<script src="/static/js/update_fix.js"></script>
</body>
</html>
