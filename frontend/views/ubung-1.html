{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/static/images/favicon.ico" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1"
    />
    <meta name="theme-color" content="#51ceec" />
    <meta name="description" content="ARK" />
    <title>Energy-Source-VOTE-1</title>
    <link rel="stylesheet" href="/static/css/app.css" />
    <link rel="stylesheet" href="/static/css/ubung-1.css" />
    <script src="/static/vue.js"></script>
    <!-- 引入样式 -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-ui/lib/theme-chalk/index.css"
    />
    <!-- 引入组件库 -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  </head>
  <body>
    <div class="app">
      <div class="app__head">
        <header class="header-main container">
          <div class="header-main__title">
            <span class="icon-logo"></span>
            <span>ARK</span>
          </div>
          <div class="header-main__user">
            <div class="user">
              <div class="user__subtitle">
                {{game.name}}
                <span class="icon-link" data-clipboard-text="#link_url"></span>
              </div>
              <img src="{{user.avatar}}" alt="" />
              <div class="user__title">{{user.name}}</div>
            </div>
          </div>
          <div class="header-main__progress">
            <div class="progress">
              <label>Mission 1</label>
              <div class="progress__bar">
                <div style="width: 5%">5%</div>
              </div>
            </div>
          </div>
        </header>
      </div>
      <div class="app__body" id="app-1">
        <div
          class="container"
          v-loading="loading"
          element-loading-text="Waiting for the server"
          element-loading-background="rgba(0, 0, 0, 0.8)"
        >
          <main class="screen ubung-1">
            <h1>Aufgabe 1: Kraftquelle des Teams.</h1>
            <p>
              Die erste Aufgabe ist anspruchsvoll und bestimmt die Struktur des
              Spiels: welche Kraft hälst du für's gute Zusammenspiel im Team für
              wesentlich?
              <br />
              <br />
            </p>
            <input
              type="text"
              placeholder="Kraftquelle"
              name="kraftquelle"
              v-model="text_input"
              @keyup.enter="add_term"
              @keyup="keyboard_()"
            />
            <label
              >*Diese Qualität wurde bereits von einem anderen Spieler
              ausgewählt.</label
            >
            <p>
              <b>
                Schreib in das leere Feld oder beweg den passenden Begriff.
              </b>
            </p>
            <div class="tags">
              <span
                :id="item.value"
                v-bind:class="{ tag: item.state==='tag', 'line-through': item.state !== 'tag'}"
                v-for="item in term_list"
                @click="mark( item.value )"
                >[[ item.value ]]</span
              >
            </div>
            <input
              id="tags"
              type="hidden"
              name="tags"
              value="输入你要传bai递的值"
            />
            <div class="center">
              <button class="submit" @click="continue_()">Weiterspielen</button>
            </div>
          </main>
        </div>
      </div>
    </div>

    <script src="/static/jquery-3.5.1.min.js"></script>
    <script src="/static/axios.min.js"></script>
    <script src="/static/popper.min.js"></script>
    <script src="/static/tippy-bundle.umd.min.js"></script>
    <script src="/static/clipboard.min.js"></script>
    <script>

      // Copy and tooltip
      new ClipboardJS('.icon-link');
      tippy('.icon-link', {
        content: 'Copy to clipboard',
      });
      tippy('.icon-link', {
        trigger: 'click',
        content: 'Copied',
      });

      // Link creation
      // TODO Code bellow Link must be from backend.
      var temp_link = '{{game.link}}';
      var url_host = window.location.host;
      var temp_link_ = url_host + '/link/' + temp_link + '/';
      document.querySelector('.icon-link').dataset.clipboardText = temp_link_;

      function sleep (time) {
          return new Promise((resolve) => setTimeout(resolve, time));
      }

      var app = new Vue({
          delimiters: ['[[', ']]'],
          el: '#app-1',
          data:{
              text_input: '',
              term_list: {{ term_list|safe }},
              loading: false,
              keyboard_input: false,
          },
          mounted(){
              var that = this;

              var flag = 0; // test whether the user have already select the term.
              var uu = 0;
              var player_id = {{user.id}};
              while (uu < that.term_list.length){
                  if (that.term_list[uu].player_id === player_id){
                      flag = 1;
                      that.text_input = that.term_list[uu].value;
                      break;
                  }
                  uu += 1;
              }

              var data_ = {
                  'player_id': '{{user.id}}',
                  'link': '{{game.link}}',
              }
              axios
                  .post(`/api/check_ubung_1/`, data_)
                  .then(function(response){
                      var result = response.data.result;
                      if (String(result) === "0"){
                          var data_ = {
                              'player_id': '{{user.id}}',
                              'link': '{{game.link}}',
                              'data': that.term_list,
                          };
                          axios
                              .post(`/api/ubung_1_api/`, data_)
                              .then(function(response){
                                  var result = response.data.result;
                                  console.log(result);
                                  that.term_list.splice(0);
                                  var uu = 0;
                                  while (uu < result.length){
                                      that.term_list.push(result[uu]);
                                      uu += 1;
                                  }
                              })
                              .catch(function(error){
                                  console.log(error);
                              })
                      }
                  })
              this.get_api_data();

          },
          methods:{
              keyboard_(){
                  var that = this;
                  that.keyboard_input = true;
                  return
              },
              get_api_data(){
                  var that = this;
                  var data_ = {
                      'player_id': '{{user.id}}',
                      'link': '{{game.link}}',
                  }
                  axios
                      .post(`/api/ubung_1_get_data/`, data_)
                      .then(function(response){
                          var result = response.data.result;
                          that.term_list.splice(0);
                          var uu = 0;
                          while (uu < result.length){
                              that.term_list.push(result[uu]);
                              uu += 1;
                          }
                      })
                      .catch(function(error){
                          console.log(error);
                      })
              },
              continue_:function(){
                  var that = this;
                  if (that.text_input === ''){
                      alert("Please choose a term.");
                      return;
                  }else{
                      if (this.keyboard_input === true){
                          app.add_term();
                      }else{
                          window.location.href = "/ubung-2/";
                      }
                  }
              },
              add_term: function(){
                  var that = this;
                  var temp = that.text_input
                  temp = temp.replace(/\s*/g,"")
                  if (that.text_input ===  ''){
                      return;
                  }
                  if (temp === ''){
                      return;
                  }
                  var flag = 0; // test whether the user have already select the term.
                  var uu = 0;
                  var player_id = {{user.id}};
                  while (uu < that.term_list.length){
                      if (that.term_list[uu].player_id === player_id){
                          flag = 1;
                          that.term_list[uu].state = 'tag';
                          break;
                      }
                      uu += 1;
                  }

                  // if have the same value, interrupt
                  var ii = 0;
                  var flag_ = 0;
                  while (ii < that.term_list.length){
                      if (that.term_list[ii].value === that.text_input){
                          flag_ = 1;
                          alert("You input the same term which is below.")
                          return;
                      }
                      ii += 1;
                  }

                  that.term_list.push({
                      'state': 'line-through',
                      'value': that.text_input,
                      'player_id': {{user.id}},
                  });
                  var data_ = {
                      'player_id': '{{user.id}}',
                      'link': '{{game.link}}',
                      'data': that.term_list,
                  };
                  axios
                      .post(`/api/ubung_1_api/`, data_)
                      .then(function(response){
                          var result = response.data.result;
                          that.term_list.splice(0);
                          var uu = 0;
                          while (uu < result.length){
                              that.term_list.push(result[uu]);
                              uu += 1;
                          }
                      })
                      .catch(function(error){
                          console.log(error);
                      })
                  window.location.href = "/ubung-2/";
              },
              mark: function(item){
                  clearInterval(refresh);
                  var that = this;
                  this.keyboard_input = false;
                  this.loading = true;
                  var player_id = {{user.id}};

                  var already_ = 0;
                  var flag = 0; // test whether the user have already select the term.
                  var uu = 0;
                  while (uu < that.term_list.length){
                      if (that.term_list[uu].player_id === player_id){
                          flag = 1;
                          already_ = uu;
                          break;
                      }
                      uu += 1;
                  }

                  var uu = 0;
                  while (uu < that.term_list.length){
                      if (that.term_list[uu].value == item){
                          if (that.term_list[uu].state === 'tag'){
                              if (flag === 1){
                                  that.term_list[already_].state = 'tag';
                              }
                              that.term_list[uu].state = 'line-through';
                              that.text_input = item;
                              break;
                          }
                          else if (that.term_list[uu].state === 'line-through'){
                              if (that.term_list[uu].player_id !== player_id){
                                  return;
                              }
                              that.term_list[uu].state = 'tag';
                              that.text_input = '';
                              break;
                          }
                      }
                      uu += 1;
                  }
                  var data_ = {
                      'player_id': '{{user.id}}',
                      'link': '{{game.link}}',
                      'data': that.term_list,
                  };
                  axios
                      .post(`/api/ubung_1_api/`, data_)
                      .then(function(response){
                          var result = response.data.result;
                          that.term_list.splice(0);
                          var uu = 0;
                          while (uu < result.length){
                              that.term_list.push(result[uu]);
                              uu += 1;
                          }
                      })
                      .catch(function(error){
                          console.log(error);
                      })
                  refresh = setTimeout(this.get_api_data,6000);

                  sleep(900).then(() => {
                      that.loading = false;
                  })
              }
          }
      })

      var refresh = setTimeout(app.get_api_data,6000);
    </script>
  </body>
</html>
