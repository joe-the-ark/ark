{% load i18n %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" href="/static/images/favicon.ico"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1"/>
    <meta name="theme-color" content="#51ceec"/>
    <meta name="description" content="ARK"/>
    <title>Waiting-Room-SQUAD</title>
    <link rel="stylesheet" href="/static/css/app.css">
    <link rel="stylesheet" href="/static/css/wartezimmer.css">
    <link rel="stylesheet" href="/static/css/app_graph.css">
    <link rel="stylesheet" href="/static/css/team-potential.css">
    <link rel="stylesheet" href="/static/css/assessment.css">
    <link rel="stylesheet" href="/static/css/load.css">
    <link rel="stylesheet" href="/static/css/waiting-room2.css">
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css"> -->
</head>
<body>
<div class="app">
    <div class="app__head">
        <header class="header-main container">
            <div class="header-main__title">
                <icon classs="icon" onClick="window.open('https://info.arks.ch/');" style="cursor: pointer; position: relative; display: inline-flex; align-items: center;">
                <span class="icon-logo"></span>
                <span>ARKS</span>
                <span class="tooltip-icon arks-logo-tooltip-icon" id="arks-logo-tooltip-icon" style="display: none; margin-left: 8px;">{% trans "Info zu safecircles.ch" %}</span>
            </icon>
            </div>
            <div class="header-main__user">
                <div class="user">
                    <div class="user__subtitle">
                        {{game.name}}
                        <span class="icon-link" data-clipboard-text="#link_url"></span>
                    </div>
                    <img src="{{avatar}}" alt="boar">
                    <div class="user__title">
                        <!-- Vasilisa Kochetkova  -->
                        {{user.name}}
                    </div>
                </div>
            </div>
            <div class="header-main__progress">
                <div class="progress">
                    <label>{% trans "Alle da?" %}</label>
                    <div class="progress__bar">
                        <div style="width: 70%; border-radius: 10px;">70%</div>
                    </div>
                </div>
            </div>
        </header>
    </div>
    <div class="app__body">
        <div class="container">
            <main class="screen wartezimmer">
                <div class="wartezimmer__data">
                    <h1>
                        <span class="tooltip-icon waiting-room2-tooltip-icon" id="waiting-room2-tooltip-icon" style="display: inline-flex; align-items: center; margin-right: 8px; vertical-align: middle; cursor: help;">?</span>
                        {% trans "Wartezimmer" %}
                    </h1>
                    <div class="results-box">
                      <p class="results-text">
                        {% trans "Erinnerst du dich an deine Einschätzung der Team-Performance? Hier siehst du euer Ergebnis:" %}
                        <br><br>

                        <div class="custom-graph-info">
                          <div class="custom-graph-info__item small" data-text="{% trans 'Minimal' %}">
                            {{ minimal }}
                          </div>
                          <div class="custom-graph-info__item base" data-text="{% trans 'Durchschnitt' %}">
                            {{ median }}
                          </div>
                          <div class="custom-graph-info__item large" data-text="{% trans 'Maximal' %}">
                            {{ maximal }}
                          </div>
                        </div>
                      </p>

                      <!-- BEGIN: Assessment‑identische Wrapper -->
                      <div class="custom-graph-wrapper"></div>
                      <!-- END: Assessment‑identische Wrapper -->

                    </div>




                <div class="google-slides-container-wrapper" style="position: relative;">
                    <button class="google-slides-fullscreen-button" id="google-slides-fullscreen-button" aria-label="{% trans 'Vollbild anzeigen' %}" title="{% trans 'Vollbild anzeigen' %}">
                        <span class="fullscreen-icon">⛶</span>
                    </button>
                    <div class="google-slides-container" id="google-slides-container">
                        <iframe src={% trans "https://docs.google.com/presentation/d/1gyEYqnALw4y9yLPUTb1VYQO9IADDD4r-1-yf0sgkvo4/embed?start=true&loop=false&delayms=8000&rm=minimal"  %} frameborder="0" width="850" height="400" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true" aria-label="{% trans 'Präsentation' %}"></iframe>
                    </div>
                </div>


                <p>
                <div class="wartezimmer__addition" id="app-1">
                    <div class="user-connect active" v-for='(value, index) in waiting_list_active'>
                        <img :src="value.avatar" alt=""/>
                        <div class="user-connect__now">
                            <span class="user-connect__now-name">
                                [[ value.name ]]
                            </span>
                            <span class="now-terms" style="text-transform: uppercase;">
                              [[ value.item_power ]] / [[ value.item_drainer ]]
                            </span>
                        </div>
                    </div>


                    <div class="user-connect" v-for='(value, index) in waiting_list_yet'>
                        <img :src="value.avatar" alt=""/>
                        <div class="user-connect__now">
                            <span class="user-connect__now-name">
                                [[ value.name ]]
                            </span>
                            <span class="now-terms">
                                {% trans "..." %}
                            </span>
                        </div>
                    </div>
                </div>
            </p>
            </main>
                    <p>
                        <br><br>
                    </p>
            <form action="#" method="POST" class="form">
            {% csrf_token %}
                <div class="center">
                    <div class="button-with-tooltip">
                        <span class="tooltip-icon continue-button-tooltip-icon" id="continue-button-tooltip-icon" style="display: inline-flex; align-items: center; margin-right: 8px; vertical-align: middle; cursor: help;">?</span>
                    <button id='main_btn' class="button button-primary" type="button" onclick="choosePopup()" aria-label="{% trans 'Weiter' %}">
                        <span class="button-text">{% trans "Weiter" %}</span>
                        <span class="button-arrow">→</span>
                    </button>
                    </div>

                    <p>
                        <br><br>
                    </p>
                </div>
                    <div class="copyright-footer">
                        <a href="https://github.com/joe-the-ark/ark" target="_blank">{% trans "ARKS is published under a GPLv3" %}</a> {% trans "license by" %} 
                        <a href="https://www.linkedin.com/in/dr-joe-maier/" target="_blank">{% trans "Dr. Joe Maier" %}</a>.
                    </div>
            </form>
        </div>
    </div>
</div>





<script src="/static/jspdf.umd.min.js"></script>
<script src="/static/dom-to-image.min.js"></script>
<script src="/static/vue.js"></script>
<script src="https://cdn.staticfile.org/element-ui/2.15.9/index.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.min.js"></script>
<script src="https://unpkg.com/tippy.js@6/dist/tippy-bundle.umd.js"></script>
<script src="https://unpkg.com/clipboard@2/dist/clipboard.min.js"></script>
<script src="/static/js/utils.js"></script>
<script src="/static/js/waitingRoomHelpers.js"></script>


<script>

    //Button remover - only show button for initiator
    function buttonRemover() {
      let initiator = "{{host}}";
      let user = "{{player_name}}";
      let btn = document.querySelector('#main_btn');
      let container = btn ? btn.closest('.button-with-tooltip') : null;
      
      if (initiator != user) {
        // Hide button and container for non-initiators
        if (btn) {
          btn.style.setProperty('display', 'none', 'important');
        }
        if (container) {
          container.style.setProperty('display', 'none', 'important');
        }
        // Also hide the center container if it only contains the button
        let centerContainer = btn ? btn.closest('.center') : null;
        if (centerContainer && centerContainer.querySelectorAll('.button-with-tooltip').length === 1 && !centerContainer.querySelectorAll('p').length) {
          centerContainer.style.setProperty('display', 'none', 'important');
        }
      }
    }
    // Call buttonRemover after DOM is ready (with small delay to ensure styles are applied)
    function initButtonRemover() {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(buttonRemover, 100);
        });
      } else {
        setTimeout(buttonRemover, 100);
      }
    }
    initButtonRemover();

    // Copy and tooltip
    new ClipboardJS('.icon-link');
    tippy('.icon-link', {
      content: "{% trans 'Spiel-Link in Zwischenablage kopieren'|escapejs %}",
    });
    tippy('.icon-link', {
      trigger: 'click',
      content: "{% trans 'Kopiert'|escapejs %}",
    });

    // ARKS Logo Tooltip
    function initARKSLogoTooltip() {
        const arksLogoContainer = document.querySelector('.header-main__title icon');
        const arksLogoTooltipIcon = document.getElementById('arks-logo-tooltip-icon');
        
        if (arksLogoContainer && arksLogoTooltipIcon) {
            arksLogoContainer.addEventListener('mouseenter', function() {
                arksLogoTooltipIcon.style.display = 'inline-flex';
            });
            arksLogoContainer.addEventListener('mouseleave', function() {
                arksLogoTooltipIcon.style.display = 'none';
            });
            
            tippy(arksLogoTooltipIcon, {
                content: "{% trans 'Info zu safecircles.ch'|escapejs %}",
                placement: 'bottom',
                theme: 'light',
                delay: [200, 0],
                allowHTML: false,
                interactive: false,
                trigger: 'mouseenter focus',
            });
        }
    }

    // Waiting Room 2 Tooltip
    function initWaitingRoom2Tooltip() {
        const waitingRoom2TooltipIcon = document.getElementById('waiting-room2-tooltip-icon');
        if (waitingRoom2TooltipIcon) {
            const existingInstance = waitingRoom2TooltipIcon._tippy;
            if (existingInstance) {
                existingInstance.destroy();
            }
            
            tippy(waitingRoom2TooltipIcon, {
                content: "{% trans 'In der Regel gilt folgender Zusammenhang: je grösser eure psychologische Sicherheit, umso höher die Team-Performance.'|escapejs %}",
                placement: 'bottom',
                theme: 'light',
                delay: [200, 0],
                allowHTML: false,
                interactive: false,
                trigger: 'mouseenter focus',
                maxWidth: 500,
            });
        }
    }

    // Continue Button Tooltip
    function initContinueButtonTooltip() {
        const continueButtonTooltipIcon = document.getElementById('continue-button-tooltip-icon');
        if (continueButtonTooltipIcon) {
            const existingInstance = continueButtonTooltipIcon._tippy;
            if (existingInstance) {
                existingInstance.destroy();
            }
            
            tippy(continueButtonTooltipIcon, {
                content: "{% trans 'Die Reise kann weitergehen, sobald alle Mitspieler hier im Warteraum angekommen sind.'|escapejs %}",
                placement: 'top',
                theme: 'light',
                delay: [200, 0],
                allowHTML: false,
                interactive: false,
                trigger: 'mouseenter focus',
                maxWidth: 400,
            });
        }
    }

    // Initialize tooltips after DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initARKSLogoTooltip();
            initWaitingRoom2Tooltip();
            initContinueButtonTooltip();
        });
    } else {
        initARKSLogoTooltip();
        initWaitingRoom2Tooltip();
        initContinueButtonTooltip();
    }

    // Link creation
    // TODO Code bellow Link must be from backend.
    var temp_link = '{{game.link}}';
    var url_host = window.location.host;
    var temp_link_ = url_host + '/link/' + temp_link + '/';
    document.querySelector('.icon-link').dataset.clipboardText = temp_link_;

    var app = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app-1',
        data() {
            return {
                activeIndex: '1',
                message: 'Hello Vue!',
                waiting_list_active: [
                {
                    'id': -1,
                    'name': '',
                    'avatar': '',
                }],
                waiting_list_yet:[{
                    'id': -1,
                    'name': '',
                    'avatar': '',
                }],
            }
        },
        methods: {
            handleSelect(key, keyPath) {
                // Handle select if needed
            },
        },
    })


    function popupOpen(selector) {
      selector.classList.add('open');
    }

    function popupClose(selector, timeout) {
      setTimeout(() => {selector.classList.remove('open')}, timeout);
    }

    function choosePopup() {
      let userList = document.querySelectorAll('.user-connect');
      let readyCount = 0;
      for (let item of userList) {
        if(item.classList.contains('active')) {
          readyCount++;
        }
      }
      if (userList.length < 3) {
        morePlayersNeeded();
      }
      else if (userList.length >= 3 && readyCount < 3) {
        letsWaitMorePlayers();
      }
      else if (userList.length >= 3 && readyCount >=3 && userList.length > readyCount){
        waitOrGo();
      }
      else if (userList.length == readyCount) {
        start();
      }
    }

    function morePlayersNeeded() {
      let popup = document.querySelector('#popup_less_players');
      popupOpen(popup);
      popupClose(popup, 1500);
    }

    function letsWaitMorePlayers() {
      let popup = document.querySelector('#popup_less_ready_players');
      popupOpen(popup);
      popupClose(popup, 1500);
    }

    function waitOrGo() {
      let popup = document.querySelector('#popup_buttons');
      popupOpen(popup);
      let closeBtn = document.querySelector('.modal_button[type=button]')
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {popupClose(popup, 0)})
      }
    }

    function start() {
      document.forms[0].submit();
    }

    function sleep(time) {
        return new Promise((resolve) => setTimeout(resolve, time));
    }

    async function get_mem_list() {
        while (1) {
            var waiting_post = {"player_id": "{{player_id}}","link":"{{link}}"};
            await sleep(4000).then(() => {
                axios
                    .post(`/api/waiting_room2_active/`,waiting_post)
                    .then(function(response) {
                        var result = response.data.result;
                        app.waiting_list_active.splice(0);
                        var uu = 0;
                        while (uu < result.length) {
                            app.waiting_list_active.push((result)[uu]);
                            uu += 1;
                        }
                        app.waiting_list_active = result;

                        axios
                            .post(`/api/waiting_room2_yet/`,waiting_post)
                            .then(function(response) {
                                var result = response.data.result;
                                app.waiting_list_yet.splice(0);
                                var uu = 0;
                                while (uu < result.length) {
                                    app.waiting_list_yet.push((result)[uu]);
                                    uu += 1;
                                }
                                app.waiting_list_yet = result;

                            })
                            .catch(function(error) {
                                // Error handled silently
                            });

                    })
                    .catch(function(error) {
                        // Error handled silently
                    });
            })
            
        }
    }

    async function check_game_start() {
        const reminderMessage = "{% trans 'Alles gut – klick einfach erneut auf „Weiter“, wenn ihr startklar seid.' %}";
        const reminder = WaitingRoomHelpers.createReminder({
            message: reminderMessage,
            firstDelayMs: 120000,
            repeatDelayMs: 210000,
            maxCount: 2
        });

        while (1) {
            var data_ = {'link': '{{link}}'};
            await sleep(12000).then(() => {
                axios
                    .post(`/api/waiting_room2_game_start/`, data_)
                    .then(function(response) {
                        var result = response.data.result;
                        if (result === 1) {
                            reminder.stop();
                            window.location.href="/psychologischer/";
                        } else {
                            reminder.touch();
                        }
                    })
                    .catch(function(error) {
                        // Error handled silently
                    });
            });
        }
    }  

    get_mem_list()
    check_game_start()







</script>

  <!-- Externe JS‑Bibliotheken (jeweils nur einmal einbinden) -->
  <script src="/static/js/AppGraph.js"></script>
  <script src="/static/axios.min.js"></script>
  <script src="/static/js/AppRange.js"></script>
  <script src="/static/js/AppFeedback.js"></script>

  <!-- Graph & Feedback initialisieren -->
  <script>
    // Haupt‑Graph
    new AppGraph({
      container: ".custom-graph-wrapper",
      data: {{ all_result|safe }},
      safezoneData: (()=>{
        let arr = [];
        for(let item of {{ all_result|safe }}) arr.push(item.statusSide);
        return arr;
      })(),
      range: [1,99],
      labelRange: ['High','Low'],
      statistic: true,
      mobile: 1200
    });

      // Mini‑Graph für User (wie in assessment.html)
      let dataTeam = {{ team_potential_all_result|safe }};
      let safezoneDataTeam = () => {
        let arr = [];
        for (let item of dataTeam) {
          arr.push(item.statusSide);
        }
        return arr;
      };
      new AppGraph({
        container: ".custom-graph-wrapper.user",
        range: [0, 100],
        labelRange: ['High', 'Low'],
        mobile: 1200,
        statistic: true,
        data: dataTeam,
        safezoneData: safezoneDataTeam()
      });
      const statisticGraph = document.querySelector(".custom-graph.statistic");
      if (statisticGraph) {
          statisticGraph.style.margin = '0 70px';
      }

  </script>

<div id='popup_buttons' class="popup">
    <div class="popup_body">
        <div class="popup_content">
            <form class="popup_form" action="#" method="post">
              {% csrf_token %}
              <button class="modal_button button" type="submit" id="button" aria-label="{% trans 'Fortfahren wenn alle Spieler grün sind' %}">
                  {% trans "Fortfahren, sobald alle Spieler GRÜN sind" %}
              </button>
              <button class="modal_button button" type="button" aria-label="{% trans 'Auf weitere Spieler warten' %}">
                  {% trans "Auf weitere Spieler warten" %}
              </button>
            </form>
        </div>
    </div>
</div>
<div id='popup_less_players' class="popup">
    <div class="popup_body">
        <div class="popup_content">
            {% trans "Lade mehr Spieler ein! Es werden mindestens 3 Spieler benötigt, um dieses Spiel zu spielen." %}
        </div>
    </div>
</div>
<div id='popup_less_ready_players' class="popup">
    <div class="popup_body">
        <div class="popup_content">
            {% trans "Warte, bis mehr Spieler hier im Warteraum angekommen sind." %}
        </div>
    </div>
</div>

    <script>
    // Google Slides Fullscreen functionality
    const fullscreenButton = document.getElementById('google-slides-fullscreen-button');
    const slidesContainerWrapper = document.querySelector('.google-slides-container-wrapper');
    
    if (fullscreenButton && slidesContainerWrapper) {
        fullscreenButton.addEventListener('click', function() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                // Enter fullscreen
                if (slidesContainerWrapper.requestFullscreen) {
                    slidesContainerWrapper.requestFullscreen();
                } else if (slidesContainerWrapper.webkitRequestFullscreen) {
                    slidesContainerWrapper.webkitRequestFullscreen();
                } else if (slidesContainerWrapper.mozRequestFullScreen) {
                    slidesContainerWrapper.mozRequestFullScreen();
                } else if (slidesContainerWrapper.msRequestFullscreen) {
                    slidesContainerWrapper.msRequestFullscreen();
                }
                slidesContainerWrapper.classList.add('fullscreen');
                fullscreenButton.querySelector('.fullscreen-icon').textContent = '⛶';
                fullscreenButton.setAttribute('aria-label', "{% trans 'Vollbild beenden'|escapejs %}");
                fullscreenButton.setAttribute('title', "{% trans 'Vollbild beenden'|escapejs %}");
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                slidesContainerWrapper.classList.remove('fullscreen');
                fullscreenButton.querySelector('.fullscreen-icon').textContent = '⛶';
                fullscreenButton.setAttribute('aria-label', "{% trans 'Vollbild anzeigen'|escapejs %}");
                fullscreenButton.setAttribute('title', "{% trans 'Vollbild anzeigen'|escapejs %}");
            }
        });
        
        // Listen for fullscreen changes
        document.addEventListener('fullscreenchange', function() {
            if (!document.fullscreenElement) {
                slidesContainerWrapper.classList.remove('fullscreen');
                fullscreenButton.querySelector('.fullscreen-icon').textContent = '⛶';
                fullscreenButton.setAttribute('aria-label', "{% trans 'Vollbild anzeigen'|escapejs %}");
                fullscreenButton.setAttribute('title', "{% trans 'Vollbild anzeigen'|escapejs %}");
            }
        });
        
        document.addEventListener('webkitfullscreenchange', function() {
            if (!document.webkitFullscreenElement) {
                slidesContainerWrapper.classList.remove('fullscreen');
                fullscreenButton.querySelector('.fullscreen-icon').textContent = '⛶';
                fullscreenButton.setAttribute('aria-label', "{% trans 'Vollbild anzeigen'|escapejs %}");
                fullscreenButton.setAttribute('title', "{% trans 'Vollbild anzeigen'|escapejs %}");
            }
        });
        
        document.addEventListener('mozfullscreenchange', function() {
            if (!document.mozFullScreenElement) {
                slidesContainerWrapper.classList.remove('fullscreen');
                fullscreenButton.querySelector('.fullscreen-icon').textContent = '⛶';
                fullscreenButton.setAttribute('aria-label', "{% trans 'Vollbild anzeigen'|escapejs %}");
                fullscreenButton.setAttribute('title', "{% trans 'Vollbild anzeigen'|escapejs %}");
            }
        });
        
        document.addEventListener('MSFullscreenChange', function() {
            if (!document.msFullscreenElement) {
                slidesContainerWrapper.classList.remove('fullscreen');
                fullscreenButton.querySelector('.fullscreen-icon').textContent = '⛶';
                fullscreenButton.setAttribute('aria-label', "{% trans 'Vollbild anzeigen'|escapejs %}");
                fullscreenButton.setAttribute('title', "{% trans 'Vollbild anzeigen'|escapejs %}");
            }
        });
    }
    </script>
</body>
</html>
