{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" href="/static/images/favicon.ico"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1"/>
    <meta name="theme-color" content="#51ceec"/>
    <meta name="description" content="ARK"/>
    <title>Ark-INSIGHTS</title>
    <link rel="stylesheet" href="/static/css/app.css">
    <link rel="stylesheet" href="/static/css/app_graph.css">
    <link rel="stylesheet" href="/static/css/assessment.css">
    <!-- <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css"> -->
    <script src="/static/jspdf.umd.min.js"></script>
    <script src="/static/html2canvas.js"></script>
    <script src="/static/dom-to-image.min.js"></script>

</head>
<body>
<div class="app">
    <div class="app__head">
        <header class="header-main container">
            <div class="header-main__title">
                <span class="icon-logo"></span>
                <span>ARK</span>
            </div>
            <div class="header-main__user">
                <div class="user">
                    <div class="user__subtitle">
                        {{game.name}}
                    </div>
                    <img src="{{user.avatar}}" alt="boar">
                    <div class="user__title">
                        {{user.name}}
                    </div>
                </div>
            </div>
            <div class="header-main__progress">
                <div class="progress">
                    <label>Mission 2</label>
                    <div class="progress__bar">
                        <div style="width: 95%">95%</div>
                    </div>
                </div>
            </div>
        </header>
    </div>
    <div class="app__body">
        <div class="container">
            <main class="screen assessment">
                <h1>
                    Auswertung deiner Reise mit der Arche
                </h1>
                <h3>
                    Team Potential Einschätzung
                </h3>
                <p>
                    Ist dein Team High oder Low Performing? Unsere Hypothese lautet: bessere Performance entsteht dank
                    höherer Psychologischer Sicherheit.
                </p>
                <div class="custom-graph-info">
                    <div class="custom-graph-info__item small" data-text="Minimal">
                        {{ team_potential_minimal }}
                    </div>
                    <div class="custom-graph-info__item base" data-text="Average">
                        {{ team_potential_median }}
                    </div>
                    <div class="custom-graph-info__item large" data-text="Maximal">
                        {{ team_potential_maximal }}
                    </div>
                </div>
                <div class="custom-graph-wrapper user"></div>
                                <h3>
                    Anonymes Feedback
                </h3>
                <div class="fields-fill__wrapper"></div>

                <p class="bold">
                    MEHR davon: Ich schätze deinen Beitrag zum gelingenden Zusammenspiel im Team…
                </p>
                {% for feedback in feedback1 %}
                    <p style="font-size: 20px;color: blue;">{{feedback}}</p>
                {% endfor %}
                <p class="bold">
                    ÄNDERN: du könntest zur psychologischen Sicherheit im Team beitragen, in dem…
                </p>
                {% for feedback in feedback2 %}
                    <p style="font-size: 20px;color: blue;">{{feedback}}</p>
                {% endfor %}
                <p class="bold">
                    FRAGEZEICHEN: ich wollte dich schon immer mal fragen…
                </p>
                {% for feedback in feedback3 %}
                    <p style="font-size: 20px;color: blue;">{{feedback}}</p>
                {% endfor %}
                <h3>
                    Psychologischer Sicherheitswert
                </h3>
                <p>
                    Hier siehst du den psychologische Sicherheitswert für dein Team auf einer Skala zwischen 0 (sehr
                    unsicher) und 5 (aussergewöhnlich sicher). Wie verhält sich dieser Wert zu deiner Einschätzung der
                    gefühlten Sicherheit im Team?
                </p>
                <div class="psychologischer__container" id="app-1">
                    <div class="distry">
                        <div class="distry__description">
                            Probleme und schwierige Themen kann ich bei dir ansprechen.
                        </div>
                        <div class="distry__thumbnails">
                            <div class="distry__user" v-for="person in row0">
                                <img :src="[[ person.avatar ]]" alt="">
                            </div>
                        </div>
                    </div>
                    <div class="team-average">
                        <div class="team-average__wrapper">
                            <div class="team-average__range" style="width: 27%">
                                <div class="team-average__circle">{{ psy_score }}</div>
                            </div>
                            <div class="team-average__down">5</div>
                            <div class="team-average__up">0</div>
                        </div>
                    </div>
                    <div class="distry">
                        <div class="distry__description">
                            Du schliesst manchmal Menschen aus dem Team aus, weil sie anders sind.
                        </div>
                        <div class="distry__thumbnails">
                            <div class="distry__user" v-for="person in row1">
                                <img :src="[[ person.avatar ]]" alt="">
                            </div>
                        </div>
                    </div>
                    <div class="distry">
                        <div class="distry__description">
                            Du arbeitest manchmal im Team auch gegen mich.
                        </div>
                        <div class="distry__thumbnails">
                            <div class="distry__user" v-for="person in row2">
                                <img :src="[[ person.avatar ]]" alt="">
                            </div>
                        </div>
                    </div>
                    <div class="distry">
                        <div class="distry__description">
                            Meine Talente werden von dir gesehen, geschätzt und ausgeschöpft.
                        </div>
                        <div class="distry__thumbnails">
                            <div class="distry__user" v-for="person in row3">
                                <img :src="[[ person.avatar ]]" alt="">
                            </div>
                        </div>
                    </div>
                    <div class="distry">
                        <div class="distry__description">
                            Wenn im Team Fehler passieren, verwendest du das gegen die Betroffenen.
                        </div>
                        <div class="distry__thumbnails">
                            <div class="distry__user" v-for="person in row4">
                                <img :src="[[ person.avatar ]]" alt="">
                            </div>
                        </div>
                    </div>
                    <div class="distry">
                        <div class="distry__description">
                            Es fällt mir schwer, dich um Hilfe zu bitten.
                        </div>
                        <div class="distry__thumbnails">
                            <div class="distry__user" v-for="person in row5">
                                <img :src="[[ person.avatar ]]" alt="">
                            </div>
                        </div>
                    </div>
                </div>

                <h3>
                    Spannungsfelder
                </h3>
                <p>
                    Diese Kräfte beschreiben deinen Einfluss auf eure Teamdynamik:
                </p>
                <ul>
                    <li>
                        Weiss deutet auf Spannungsfreiheit hin.
                    </li>
                    <li>
                        Werte über 16 deuten auf Spannungen im Team hin.
                    </li>
                    <li>
                        Bei roten Werten liegt deine Selbstwahrnehmung ausserhalb der
                        psychologischen Sicherheitszone.
                    </li>
                    <li>
                        Bei gelben Werten liegt die Fremdwahrnehmung ausserhalb der
                        psychologischen Sicherheitszone.
                    </li>
                    <li>
                        Bei gelben und roten Werten liegen deine Selbst- und die Fremdwahrnehmung ausserhalb der
                        psychologischen Sicherheitszone eures Teams.
                    </li>
                </ul>
                <div id="rang-slider" class="swiper-container">
                    <div class="swiper-wrapper">
                    </div>
                </div>

                <div id="graph-slider" class="swiper-container">
                    <div class="swiper-wrapper">
                    </div>
                    <div class="swiper-button-prev"></div>
                    <div class="swiper-button-next"></div>
                    <div class="swiper-pagination"></div>
                </div>


                <div class="center">
                    <a href="/arche/" class="button" id="button">
                        Auf wiedersehen sagen
                    </a>
                </div>
            </main>
        </div>
    </div>
</div>
<!-- <button class="btn"> Save pdf</button> -->
<script src="/static/js/AppGraph.js"></script>
<script src="/static/js/AppRange.js"></script>
<script src="/static/js/AppFeedback.js"></script>
<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
<script src="/static/js/utils.js"></script>
<script>
    const isMobile = () => window.innerWidth <= 1200;
    let jsonAll = {{ json_all|safe }};
    var json_list = {{ span_json_list|safe }};
    function deal_json(json_list, num){
        var new_json_list = [];
        var uu = 0;
        while (uu < json_list.length){
            if (uu == num){
                new_json_list.push(json_list[uu]);
            }else{
                var temp = {statusSide:json_list[uu]['statusSide'] };
                new_json_list.push(temp);
            }
            uu += 1;
        }
        return new_json_list;
    }

    //console.log(json_list);
    //console.log(deal_json(json_list, 0));

    function format_data(json_list){
        var num = json_list.length;
        var result = [];
        var uu = 0;
        while (uu < num){
            var temp = {
                range: [1, 99],
                labelRange: ['Low', 'High'],
                data: deal_json(json_list, uu)
            };
            result.push(temp);
            uu += 1;
        }
        return result;
    }
    const data = format_data(json_list);
    console.log(data);

    let user = "{{ user.name }}";
    const wrapper = document.querySelector('#graph-slider .swiper-wrapper');
    let htmlWrappers = ``;

    dataForGraph(jsonAll, user).forEach((item, i) => {
        htmlWrappers += `<div class="swiper-slide slide-${i}"></div>
                        <div class="custom-graph-info">
                    <div class="custom-graph-info__item small" data-text="Others">
                        
                    </div>
                    <div class="custom-graph-info__item base" data-text="Self">
                        
                    </div>
                    <div class="custom-graph-info__item large" data-text="Tension">
                        
                    </div>
                </div>`;
    });

    wrapper.innerHTML = htmlWrappers;

    let newapp = new AppRange({
        container: '#rang-slider',
        innerWrapper: isMobile() ? 'rang swiper-wrapper' : 'rang',
        // data: data.map(({data}) => {
        //     const dataSort = data.filter(el => el.name);
        //     const {name, avatar, statusSide, value} = dataSort[0];
        //     return {
        //         name,
        //         avatar,
        //         statusSide,
        //         value,
        //     }
        // }),
        data:dataForRange(jsonAll, user),
        callback(item, i) {
            if (!isMobile()) {
                const itemClickable = document.querySelectorAll('#graph-slider .swiper-pagination-bullet');
                // itemClickable[i].click();
                // item.classList.add('active');
                // bottomValues = document.querySelector('.custom-graph-info').children;
                // bottomValues[0].innerText = this.data[i].others;
                // bottomValues[1].innerText = this.data[i].self;
                // bottomValues[2].innerText = this.data[i].tension;
            }
        },
        update(item) {
            if (!isMobile()) {
                item.classList.remove('active');
            }
        },
        loadEnd() {
            document.querySelectorAll('.rang__item').forEach((item) => {
                item.classList.remove('active');
            })
            $self = this;
            // let contNum = i;
            if (isMobile()) {
                let swipeMob = new Swiper(this.container, {
                    slidesPerView: 6,
                    spaceBetween: 0,
                    centeredSlides: true,
                    grabCursor: true,
                    loop: false,
                    breakpoints: {
                        768: {
                            slidesPerView: 3,
                            spaceBetween: 0,
                        },
                        480: {
                            slidesPerView: 2,
                            spaceBetween: 0,
                        },
                        320: {
                            slidesPerView: 1,
                            spaceBetween: 0,
                        },
                    },
                    navigation: {
                        nextEl: '.rang-button-next',
                        prevEl: '.rang-button-prev',
                    },
                    pagination: {
                        el: '.swiper-pagination',
                        type:"bullets",
                        clickable: true,
                    },
                    on: {
                        slideChange(a, b, c) {
                            // const index = a.realIndex;
                            // const itemClickable = document.querySelectorAll('#graph-slider .swiper-pagination-bullet');
                            // itemClickable[index].click();
                            // bottomValues = document.querySelector('.custom-graph-info').children;
                            // // console.log($self.data);
                            // bottomValues[0].innerText = $self.data[index].others;
                            // bottomValues[1].innerText = $self.data[index].self;
                            // bottomValues[2].innerText = $self.data[index].tension;
                        }
                    }
                });
            }
        }
    });

    // new AppRange({
    //     container: '#rang-slider',
    //     innerWrapper: isMobile() ? 'rang swiper-wrapper' : 'rang',
    //     data: data.map(({data}) => {
    //         const dataSort = data.filter(el => el.name);
    //         const {name, avatar, statusSide} = dataSort[0];
    //         return {
    //             name,
    //             avatar,
    //             statusSide
    //         }
    //     }),
    //     callback(item, i) {
    //         if (!isMobile()) {
    //             const itemClickable = document.querySelectorAll('#graph-slider .swiper-pagination-bullet');
    //             itemClickable[i].click();
    //             item.classList.add('active');
    //         }
    //     },
    //     update(item) {
    //         if (!isMobile()) {
    //             item.classList.remove('active');
    //         }
    //     },
    //     loadEnd() {
    //         if (isMobile()) {
    //             new Swiper(this.container, {
    //                 slidesPerView: 6,
    //                 spaceBetween: 0,
    //                 centeredSlides: true,
    //                 grabCursor: true,
    //                 loop: true,
    //                 breakpoints: {
    //                     768: {
    //                         slidesPerView: 3,
    //                         spaceBetween: 0,
    //                     },
    //                     480: {
    //                         slidesPerView: 2,
    //                         spaceBetween: 0,
    //                     },
    //                     320: {
    //                         slidesPerView: 1,
    //                         spaceBetween: 0,
    //                     },
    //                 },
    //                 navigation: {
    //                     nextEl: '.rang-button-next',
    //                     prevEl: '.rang-button-prev',
    //                 },
    //                 on: {
    //                     slideChange(a, b, c) {
    //                         const index = a.realIndex;
    //                         const itemClickable = document.querySelectorAll('#graph-slider .swiper-pagination-bullet');
    //                         itemClickable[index].click();
    //                     }
    //                 }
    //             });
    //         }
    //     }
    // });

    // Team potential graph


    //Spanung graph
    dataForGraph(jsonAll, user).forEach((item, i) => {
        new AppGraph({
            container: `.swiper-slide.slide-${i}`,
            range: item.range,
            labelRange: item.labelRange,
            mobile: 1200,
            statistic: true,
            data: item.data,
            safezoneData: safezoneData(jsonAll,item.data[0].value),
            graphNumber: i,
        });
    });

    // new Swiper('#graph-slider', {
    //     grabCursor: true,
    //     navigation: {
    //         nextEl: '.swiper-button-next',
    //         prevEl: '.swiper-button-prev',
    //     },
    //     pagination: {
    //         el: '.swiper-pagination',
    //         clickable: true
    //     }
    // });

    let dataTeam = {{ team_potential_all_result|safe }};
    let safezoneDataTeam = () => {
        let arr = [];
        for(let item of dataTeam) {
            arr.push(item.statusSide);
        }
        return arr
    }
    new AppGraph({
        container: '.custom-graph-wrapper.user',
        range: [1, 99],
        labelRange: ['Low', 'High'],
        mobile: 1200,
        statistic: true,
        data: dataTeam,
        safezoneData: safezoneDataTeam(),

    });


    cardsPainting(dataForRange(jsonAll, user), document.querySelectorAll(".rang__item"))
    function circlesValue(dataForRange, selectors) {
        selectors.forEach((item,i) => {
            item.children[0].innerText = dataForRange[i].others;
            item.children[1].innerText = dataForRange[i].self;
            item.children[2].innerText = dataForRange[i].tension;
        })
    }
    circlesValue(dataForRange(jsonAll, user), document.querySelectorAll('.swiper-wrapper .custom-graph-info'))




</script>
{% comment %} <script src="/static/js/update_fix.js"></script> {% endcomment %}
<script src="/static/vue.js"></script>
<script>
    var app = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app-1',
        data() {
            return {
                message: 'Hello Vue!',
                row0: {{ row0|safe }},
                row1: {{ row1|safe }},
                row2: {{ row2|safe }},
                row3: {{ row3|safe }},
                row4: {{ row4|safe }},
                row5: {{ row5|safe }},
            }
        },
        methods: {
            handleSelect(key, keyPath) {
                console.log(key, keyPath);
            },
        },
    })

    let doc = new jspdf.jsPDF({
        orientation: 'p',
        unit: 'px',
        format: 'a4',
        putOnlyUsedFonts:true,
    });

    let userBar = document.querySelector('.user');
    let mainH1 = document.querySelector('main').querySelector('h1').innerText;
    let mainH3 = document.querySelector('main').querySelector('h3').innerText;
    let mainP = document.querySelector('main').querySelector('p').innerText;
    let teamThree = {};
    let teamGraph = {};
    let psychoH3 = document.querySelectorAll('h3')[1].innerText;
    let psychoP = document.querySelectorAll('p')[1].innerText;
    let psychoCont = {};
    let spanunH3 = document.querySelectorAll('h3')[2].innerText;
    let spanunP = document.querySelectorAll('p')[2].innerText;
    let spanunUl = document.querySelector('ul');
    let spanunThree = document.querySelectorAll('.custom-graph-info')[1];
    let avatar = {};
    let titleIcon = {};
    let gameName = document.querySelector('.user__subtitle').innerText;
    let playerName = document.querySelector('.user__title').innerText;
    // let distry0 = imageToVar(document.querySelectorAll('.distry')[0]);

    function imageToVar(selector) {
        domtoimage.toPng(selector)
            .then(async function (dataUrl) {
                var img = await new Image();
                img.src = dataUrl;
                return img
            })
            .catch(function (error) {
                console.error('oops, something went wrong!', error);
            });
    }

    function collectImages() {
        domtoimage.toPng(document.querySelector('.user').querySelector('img'))
            .then(function (dataUrl) {
                var img = new Image();
                img.src = dataUrl;
                avatar = img;

            })
            .catch(function (error) {
                console.error('oops, something went wrong!', error);
            });



        domtoimage.toPng(document.querySelector('.header-main__title'))
            .then(function (dataUrl) {
                var img = new Image();
                img.src = dataUrl;
                titleIcon = img;
            })
            .catch(function (error) {
                console.error('oops, something went wrong!', error);
            });
        domtoimage.toPng(document.querySelector('.custom-graph-info'))
            .then(function (dataUrl) {
                var img = new Image();
                img.src = dataUrl;
                teamThree = img;
            })
            .catch(function (error) {
                console.error('oops, something went wrong!', error);
            });
        domtoimage.toPng(document.querySelector('.custom-graph.statistic'))
            .then(function (dataUrl) {
                var img = new Image();
                img.src = dataUrl;
                teamGraph = img;
            })
            .catch(function (error) {
                console.error('oops, something went wrong!', error);
            });
        domtoimage.toPng(document.querySelector('.psychologischer__container'))
            .then(function (dataUrl) {
                var img = new Image();
                img.src = dataUrl;
                psychoCont = img;
            })
            .catch(function (error) {
                console.error('oops, something went wrong!', error);
            });
    }

    function zoomLvl(img) {
        return img.height/img.width;
    }

    function getPdf() {
        doc.setFont('Helvetica', "bold");
        doc.setDrawColor(81,206,236);
        doc.setFillColor(81,206,236);
        doc.rect(0,0,446,100,"F");
        doc.addImage(titleIcon, 'png', 50, 40);
        doc.addImage(avatar, 'png', 230, 40);
        doc.setFontSize(18);
        doc.text(playerName, 270, 60);
        doc.text(gameName, 270, 40);
        doc.text(mainH1, 30, 120);
        doc.setFontSize(16);
        doc.text(mainH3, 30, 140);
        doc.setFont('Helvetica', "normal");
        doc.setFontSize(12);
        doc.text(mainP, 30, 155, {maxWidth:380.});
        doc.addImage(teamThree, 'png', 30, 175, 150, 150*zoomLvl(teamThree));
        doc.addImage(teamGraph, 'png', 30, 210, 400, 400*zoomLvl(teamGraph));

        doc.addPage('a4', 'portrait');
        doc.setFontSize(18);
        doc.setFont('Helvetica', "bold");
        doc.setDrawColor(81,206,236);
        doc.setFillColor(81,206,236);
        doc.rect(0,0,446,100,"F");
        doc.addImage(titleIcon, 'png', 50, 40);
        doc.addImage(avatar, 'png', 230, 40);
        doc.text(playerName, 270, 60);
        doc.text(gameName, 270, 40);
        doc.setFont('Helvetica', "bold");
        doc.setFontSize(16);
        doc.text(psychoH3, 30, 120);
        doc.setFont('Helvetica', "normal");
        doc.setFontSize(12);
        doc.text(psychoP, 30, 140, {maxWidth:380.});
        doc.addImage(psychoCont, 'png', 30, 160, 400, 400*zoomLvl(psychoCont));
        
        doc.save();





        // 
        // doc.setFontSize(24);
        // doc.text(mainH1, 20, 50);
        // doc.setFontSize(20);
        // doc.text(mainH3, 20, 70);
        // doc.setFontSize(14);
        // doc.text(mainP, 20, 90, {maxWidth:400.});
    }


    // document.querySelector('.btn').addEventListener('click', () => { 
    //     getPdf();
    // })


</script>
</body>
</html>
