{% load i18n %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" href="/static/images/favicon.ico"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1"/>
    <meta name="theme-color" content="#51ceec"/>
    <meta name="description" content="ARK"/>
    <title>First-Mission-INFO</title>
    <link rel="stylesheet" href="/static/css/app.css">
    <link rel="stylesheet" href="/static/css/preview.css">
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
</head>
<body>
  {% get_current_language as LANGUAGE_CODE %}
  <!-- Current language: {{ LANGUAGE_CODE }} -->
<div class="app">
    <div class="app__head">
        <header class="header-main container">
            <div class="header-main__title">
                <icon classs="icon" onClick="window.open('https://info.arks.ch/');" style="cursor: pointer; position: relative; display: inline-flex; align-items: center;">
                <span class="icon-logo"></span>
                <span>ARKS</span>
                <span class="tooltip-icon arks-logo-tooltip" id="arks-logo-tooltip-icon" style="display: none; margin-left: 8px;">{% trans "Info zu safecircles.ch" %}</span>
            </icon>
            </div>

            <div class="header-main__user" style="background-color: #FFFFFF; color: #626262; border-radius: 10px; padding: 10px;">
              <div class="header-user-content">
                <div class="language-selector-wrapper">
              <div class="language-selector" style="display:inline-block;">
                <form action="{% url 'set_language' %}" method="post" style="vertical-align:middle;">{% csrf_token %}
                    <input name="next" type="hidden" value="">
                        {% get_current_language as LANGUAGE_CODE %}
                        {% if LANGUAGE_CODE == 'zh-hans' %}
                            <img id="flag" src="{% static 'images/flags/4_zh-hans_transparent.png' %}" style="width:20%;vertical-align:middle;padding-left:1px" alt="language flag">
                        {% elif LANGUAGE_CODE == 'de' %}
                            <img id="flag" src="{% static 'images/flags/1_de_transparent.png' %}" style="width:20%;vertical-align:middle;padding-left:1px" alt="language flag">
                        {% elif LANGUAGE_CODE == 'fr' %}
                            <img id="flag" src="{% static 'images/flags/3_fr_transparent.png' %}" style="width:20%;vertical-align:middle;padding-left:1px" alt="language flag">
                        {% elif LANGUAGE_CODE == 'tr' %}
                            <img id="flag" src="{% static 'images/flags/5_tr_transparent.png' %}" style="width:20%;vertical-align:middle;padding-left:1px" alt="language flag">
                        {% else %}
                            <img id="flag" src="{% static 'images/flags/2_en_transparent.png' %}" style="width:20%;vertical-align:middle;padding-left:1px" alt="language flag">
                        {% endif %}
                        <select onchange="updateLanguageFlag(); this.form.submit();" name="language" id="select_" style="width: auto; vertical-align:middle; border-radius: 10px; padding: 10px;" aria-label="{% trans 'Sprache auswÃ¤hlen' %}">
                            <option value="" selected>{% trans "Sprachauswahl" %}</option>
                        {% get_available_languages as LANGUAGES %}
                        {% get_language_info_list for LANGUAGES as languages %}
                        {% for language in languages %}
                                <option value="{{ language.code }}">
                                    {{ language.name_local }}
                            </option>
                        {% endfor %}
                    </select>
                </form>
              </div>
                    </div>
                <div class="user-info-compact">
                    <img src="{{user.avatar}}" alt="{{user.name}}" class="user-avatar-compact">
                    <div class="user-details-compact">
                        <div class="user-name-compact">{{user.name}}</div>
                        <div class="game-name-compact">{{ game.name }}</div>
                    </div>
                    </div>
                </div>
            </div>
            <div class="header-main__progress">
                <div class="progress">
                    <label>BIG PICTURE</label>
                    <div class="progress__bar">
                        <div style="width: 3%; border-radius: 10px;">3%</div>
                    </div>
                </div>
            </div>
        </header>
    </div>
    <div class="app__body">

        <div class="container">

            <main class="screen preview">
                <h1>
                    {% trans "Schafft eine dramafreie Zusammenarbeit durch psychologisch sichere Kreise." %}
                </h1>

                <div class="preview__main">

                    <div class="preview__data">
                        <div class="preview__thumbnail">
                        <div class="google-slides-container-wrapper" style="position: relative;">
                            <div class="google-slides-tooltip-trigger" id="google-slides-tooltip-trigger">
                                <span class="tooltip-icon google-slides-tooltip-icon">?</span>
                            </div>
                            <button class="google-slides-fullscreen-button" id="google-slides-fullscreen-button" aria-label="{% trans 'Vollbild anzeigen' %}" title="{% trans 'Vollbild anzeigen' %}">
                                <span class="fullscreen-icon">â›¶</span>
                            </button>
                            <div class="google-slides-container" id="google-slides-container" role="region" aria-label="{% trans 'PrÃ¤sentation' %}">
                                <iframe style="padding: 0 10px;" src={% trans "https://docs.google.com/presentation/d/1EnXkRYGm6M0Rbkkt6iFkhZ-kjo7jDjI23eDUntHLRN0/embed?start=true&loop=false&delayms=8000&rm=minimal"  %} frameborder="0" width="850" height="400" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true" title="{% trans 'PrÃ¤sentation' %}"></iframe>
                            </div>
                        </div>

                        <div class="button-container" style="text-align: center; margin: 30px 0;">
                        <a href="/ubung-2/" aria-label="{% trans 'Weiter zur nÃ¤chsten Seite' %}">
                        <button class="button button-primary" type="button" aria-label="{% trans 'Weiter' %}">
                            <span class="button-text">{% trans "Weiter" %}</span>
                            <span class="button-arrow">â†’</span>
                        </button></a>
                        </div>
                    </div>
                    </div>  

                    <div class="qrcode-container">
                        <div class="qrcode-header">
                        <h3>
                            {% trans "Teile diesen QR-Code, um Mitreisende einzuladen" %}
                        </h3>            
                            <button type="button" class="qrcode-download-button" id="qrcode-download-button" aria-label="{% trans 'QR-Code herunterladen' %}" title="{% trans 'QR-Code als Bild speichern' %}">
                                <span class="download-icon">â¬‡</span>
                            </button>
                        </div>
                        <div id="qrcode" class="qrcode-wrapper" role="img" aria-label="{% trans 'QR-Code zum Teilen' %}"></div>
                        <div class="qrcode-link-section">
                            <button class="copy-link-button" id="copy-link-button" type="button" aria-label="{% trans 'Link kopieren' %}" data-clipboard-text="#link_url">
                                <span class="copy-link-icon">ðŸ“‹</span>
                                <span class="copy-link-text">{% trans "Link kopieren" %}</span>
                                <span class="copy-link-success" style="display: none;">âœ“ {% trans "Kopiert!" %}</span>
                            </button>
                        </div>
                        <p class="qrcode-hint">
                            {% trans "(oder bitte den Initiator um den Link im Zwischenspeicher)." %}
                        </p>
                    </div>

                        <!-- Ship tooltip trigger - positioned over the ship image -->
                        <div class="ship-tooltip-trigger" id="ship-tooltip-trigger">
                            <span class="tooltip-icon ship-tooltip-icon">?</span>
                        </div>

                </div>

                <div class="copyright-footer">
                    <a href="https://github.com/joe-the-ark/ark" target="_blank">{% trans "ARKS is published under a GPLv3" %}</a> {% trans "license by" %} 
                    <a href="https://www.linkedin.com/in/dr-joe-maier/" target="_blank">{% trans "Dr. Joe Maier" %}</a>.
                </div>
            </main>
        </div>
    </div>
</div>
</body>
<script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.min.js"></script>
<script src="https://unpkg.com/tippy.js@6/dist/tippy-bundle.umd.js"></script>
<script src="https://unpkg.com/clipboard@2/dist/clipboard.min.js"></script>
<script src="/static/jquery-3.5.1.min.js"></script>

<script>
        // Link creation
        var temp_link = '{{ game.link }}';
        var url_host = window.location.host;
        var temp_link_ = url_host + '/link/' + temp_link;
        
        // Copy link button with improved feedback
        const copyLinkButton = document.getElementById('copy-link-button');
        const copyLinkText = copyLinkButton ? copyLinkButton.querySelector('.copy-link-text') : null;
        const copyLinkSuccess = copyLinkButton ? copyLinkButton.querySelector('.copy-link-success') : null;
        
        if (copyLinkButton) {
            copyLinkButton.dataset.clipboardText = temp_link_;
            const clipboard = new ClipboardJS(copyLinkButton);
            
            clipboard.on('success', function(e) {
                e.clearSelection();
                
                // Show success feedback
                if (copyLinkText) copyLinkText.style.display = 'none';
                if (copyLinkSuccess) {
                    copyLinkSuccess.style.display = 'inline';
                    copyLinkButton.classList.add('copy-link-button--success');
                }
                
                // Reset after 2 seconds
                setTimeout(function() {
                    if (copyLinkText) copyLinkText.style.display = 'inline';
                    if (copyLinkSuccess) copyLinkSuccess.style.display = 'none';
                    copyLinkButton.classList.remove('copy-link-button--success');
                }, 2000);
            });
            
            clipboard.on('error', function(e) {
                console.error('Failed to copy link:', e);
            });
        }
        
        // ARKS Logo Tooltip
        const arksLogoContainer = document.querySelector('.header-main__title icon');
        const arksLogoTooltipIcon = document.getElementById('arks-logo-tooltip-icon');
        
        if (arksLogoContainer && arksLogoTooltipIcon) {
            arksLogoContainer.addEventListener('mouseenter', function() {
                arksLogoTooltipIcon.style.display = 'inline-flex';
            });
            
            arksLogoContainer.addEventListener('mouseleave', function() {
                arksLogoTooltipIcon.style.display = 'none';
            });
            
            tippy(arksLogoTooltipIcon, {
                content: "{% trans 'Info zu safecircles.ch'|escapejs %}",
                placement: 'bottom',
                theme: 'light',
                delay: [200, 0],
                allowHTML: false,
                interactive: false,
                trigger: 'mouseenter focus',
            });
        }
        
        // Update language flag function
        function updateLanguageFlag() {
            var lang_code = $('#select_').val();
    if (lang_code == 'zh-hans'){
        $("#flag").attr("src", "{% static 'images/flags/4_zh-hans_transparent.png'%}");
    } else if (lang_code == 'de'){
        $("#flag").attr("src", "{% static 'images/flags/1_de_transparent.png'%}");
    } else if (lang_code == 'en'){
        $("#flag").attr("src", "{% static 'images/flags/2_en_transparent.png'%}");
    } else if (lang_code == 'fr'){
        $("#flag").attr("src", "{% static 'images/flags/3_fr_transparent.png'%}");
            } else if (lang_code == 'tr'){
                $("#flag").attr("src", "{% static 'images/flags/5_tr_transparent.png' %}");
            }
        }
        
        // Initialize language flag on page load
        updateLanguageFlag();
        
        // Set "Sprachauswahl" as default display in select (flag shows current language)
        $(document).ready(function() {
            $('#select_').val('');
        });
        
        // Ship tooltip
        const shipTooltipTrigger = document.getElementById('ship-tooltip-trigger');
        if (shipTooltipTrigger) {
            tippy(shipTooltipTrigger, {
                content: "{% trans 'In den nÃ¤chsten 60 Minuten erkundet ihr die Basis eurer inneren und psychologischen Sicherheit: in welchen psychologischen safecircles arbeitet ihr schon?'|escapejs %}",
                placement: 'right',
                theme: 'light',
                delay: [200, 0],
                allowHTML: false,
                interactive: false,
                trigger: 'mouseenter focus',
                maxWidth: 300,
            });
        }
        
        // Google Slides tooltip
        const googleSlidesTooltipTrigger = document.getElementById('google-slides-tooltip-trigger');
        if (googleSlidesTooltipTrigger) {
            tippy(googleSlidesTooltipTrigger, {
                content: "{% trans 'In psychologisch sicheren Teams gelingen Lernprozesse und die Team Performance stimmt. Innere Sicherheit erlaubt es achtsam mit dir und anderen in Beziehung zu gehen. Dadurch werden Defensivreaktionen (Fight, Flight, Freeze & Fawn) Ã¼berflÃ¼ssig.'|escapejs %}",
                placement: 'top',
                theme: 'light',
                delay: [200, 0],
                allowHTML: false,
                interactive: false,
                trigger: 'mouseenter focus',
                maxWidth: 400,
            });
        }
        
        // Google Slides Fullscreen functionality
        const fullscreenButton = document.getElementById('google-slides-fullscreen-button');
        const slidesContainerWrapper = document.querySelector('.google-slides-container-wrapper');
        
        if (fullscreenButton && slidesContainerWrapper) {
            fullscreenButton.addEventListener('click', function() {
                if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                    // Enter fullscreen
                    if (slidesContainerWrapper.requestFullscreen) {
                        slidesContainerWrapper.requestFullscreen();
                    } else if (slidesContainerWrapper.webkitRequestFullscreen) {
                        slidesContainerWrapper.webkitRequestFullscreen();
                    } else if (slidesContainerWrapper.mozRequestFullScreen) {
                        slidesContainerWrapper.mozRequestFullScreen();
                    } else if (slidesContainerWrapper.msRequestFullscreen) {
                        slidesContainerWrapper.msRequestFullscreen();
                    }
                    slidesContainerWrapper.classList.add('fullscreen');
                    fullscreenButton.querySelector('.fullscreen-icon').textContent = 'â›¶';
                    fullscreenButton.setAttribute('aria-label', "{% trans 'Vollbild beenden'|escapejs %}");
                    fullscreenButton.setAttribute('title', "{% trans 'Vollbild beenden'|escapejs %}");
                } else {
                    // Exit fullscreen
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.mozCancelFullScreen) {
                        document.mozCancelFullScreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    }
                    slidesContainerWrapper.classList.remove('fullscreen');
                    fullscreenButton.querySelector('.fullscreen-icon').textContent = 'â›¶';
                    fullscreenButton.setAttribute('aria-label', "{% trans 'Vollbild anzeigen'|escapejs %}");
                    fullscreenButton.setAttribute('title', "{% trans 'Vollbild anzeigen'|escapejs %}");
                }
            });
            
            // Listen for fullscreen changes
            document.addEventListener('fullscreenchange', function() {
                if (!document.fullscreenElement) {
                    slidesContainerWrapper.classList.remove('fullscreen');
                    fullscreenButton.querySelector('.fullscreen-icon').textContent = 'â›¶';
                    fullscreenButton.setAttribute('aria-label', "{% trans 'Vollbild anzeigen'|escapejs %}");
                    fullscreenButton.setAttribute('title', "{% trans 'Vollbild anzeigen'|escapejs %}");
                }
            });
            
            document.addEventListener('webkitfullscreenchange', function() {
                if (!document.webkitFullscreenElement) {
                    slidesContainerWrapper.classList.remove('fullscreen');
                    fullscreenButton.querySelector('.fullscreen-icon').textContent = 'â›¶';
                    fullscreenButton.setAttribute('aria-label', "{% trans 'Vollbild anzeigen'|escapejs %}");
                    fullscreenButton.setAttribute('title', "{% trans 'Vollbild anzeigen'|escapejs %}");
                }
            });
            
            document.addEventListener('mozfullscreenchange', function() {
                if (!document.mozFullScreenElement) {
                    slidesContainerWrapper.classList.remove('fullscreen');
                    fullscreenButton.querySelector('.fullscreen-icon').textContent = 'â›¶';
                    fullscreenButton.setAttribute('aria-label', "{% trans 'Vollbild anzeigen'|escapejs %}");
                    fullscreenButton.setAttribute('title', "{% trans 'Vollbild anzeigen'|escapejs %}");
                }
            });
            
            document.addEventListener('MSFullscreenChange', function() {
                if (!document.msFullscreenElement) {
                    slidesContainerWrapper.classList.remove('fullscreen');
                    fullscreenButton.querySelector('.fullscreen-icon').textContent = 'â›¶';
                    fullscreenButton.setAttribute('aria-label', "{% trans 'Vollbild anzeigen'|escapejs %}");
                    fullscreenButton.setAttribute('title', "{% trans 'Vollbild anzeigen'|escapejs %}");
                }
            });
        }





    // QR Code generation with responsive sizing
    function generateQRCode() {
        const qrcodeElement = document.getElementById("qrcode");
        if (!qrcodeElement) return;
        
        // Clear existing QR code
        qrcodeElement.innerHTML = '';
        
        // Responsive QR code size
        const isMobile = window.innerWidth < 768;
        const qrSize = isMobile ? 200 : 300;
        
        var qr = new QRCode(qrcodeElement, {
            text: temp_link_,
            width: qrSize,
            height: qrSize,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
        
        // Store QR code canvas for download
        window.qrCanvas = qrcodeElement.querySelector('canvas');
    }
    
    // Generate QR code on load
    generateQRCode();
    
    // Regenerate QR code on resize
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
            generateQRCode();
        }, 300);
    });
    
    // QR Code download functionality
    const qrcodeDownloadButton = document.getElementById('qrcode-download-button');
    if (qrcodeDownloadButton) {
        qrcodeDownloadButton.addEventListener('click', function() {
            const canvas = window.qrCanvas || document.querySelector('#qrcode canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = 'qrcode-' + temp_link + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                // Show success feedback
                const originalText = qrcodeDownloadButton.innerHTML;
                qrcodeDownloadButton.innerHTML = '<span class="download-icon">âœ“</span>';
                qrcodeDownloadButton.classList.add('qrcode-download-button--success');
                
                setTimeout(function() {
                    qrcodeDownloadButton.innerHTML = originalText;
                    qrcodeDownloadButton.classList.remove('qrcode-download-button--success');
                }, 2000);
            }
        });
    }



</script>

</html>
