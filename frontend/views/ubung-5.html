{% load i18n %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" href="/static/images/favicon.ico"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1"/>
    <meta name="theme-color" content="#51ceec"/>
    <meta name="description" content="ARK"/>
    <title>Team-Tensions-VOTE-5</title>
    <link rel="stylesheet" href="/static/css/app.css">
    <link rel="stylesheet" href="/static/css/ubung-5.css">
    <script src="/static/vue.js"></script>
    <!-- å¼•å…¥æ ·å¼ -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- å¼•å…¥ç»„ä»¶åº“ -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
</head>
<body>
  {% get_current_language as LANGUAGE_CODE %}
<div class="app">
    <div class="app__head">
        <header class="header-main container">
            <div class="header-main__title">
                <icon classs="icon" onClick="window.open('https://info.arks.ch/');" style="cursor: pointer; position: relative; display: inline-flex; align-items: center;">
                <span class="icon-logo"></span>
                <span>ARKS</span>
                <span class="tooltip-icon arks-logo-tooltip-icon" id="arks-logo-tooltip-icon" style="display: none; margin-left: 8px;">{% trans "Info zu safecircles.ch" %}</span>
            </icon>
            </div>
            <div class="header-main__user">
                <div class="user">
                    <div class="user__subtitle">
                        {{game.name}}
                    </div>
                    <img src="{{user.avatar}}" alt="">
                    <div class="user__title">
                        {{user.name}}
                    </div>
                </div>
            </div>
            <div class="header-main__progress">
                <div class="progress">
                <p class="rotate-hint">
                    <span class="rotate-hint-icon">ðŸ“±</span>
                    <span>{% trans "Bitte dreh dein GerÃ¤t um 90Â° fÃ¼r eine bessere Lesbarkeit." %}</span>
                </p>
                    <div class="progress__bar">
                        <div id="ubung5-progress-bar" class="progress-bar-fill">40%</div>
                    </div>
                </div>
            </div>
        </header>
    </div>
    <div class="app__body">
        <div class="container">
            <main class="screen ubung-5">
                <h1>
                    <span class="tooltip-icon ubung5-tooltip-icon" id="ubung5-tooltip-icon" style="display: inline-flex; align-items: center; margin-right: 8px; vertical-align: middle; cursor: help;">?</span>
                    {% trans "Wie schÃ¤tzt du den Beitrag jedes Teammitglieds zu diesem Sicherheitsanker in der tÃ¤glichen Zusammenarbeit ein?" %}
                </h1>

                <p class="info-box-ubung5">
                    {% trans "Deine EinschÃ¤tzung ist ANONYM â€“ KLICKE auf die Skala von +50 bis -50." %}
                </p>

                <div class="ubung5-content-box">
                <div class="custom-graph-wrapper"></div>
            </div>

                    <div class="center">
                        <input id="data" type="hidden" name="data" value=""/>
                        <input type="hidden" name="ubung1_id" value="{{ubung1.id}}">
                        <input type="hidden" name="ubung3_id" value="{{ubung3.id}}">
                        <div id="validation-error" class="validation-error" role="alert" aria-live="polite" style="display: none;">
                            <strong>{% trans "Bitte bewerte alle Teammitglieder" %}</strong><br>
                            <span class="validation-error-text" id="validation-error-text"></span>
                        </div>
                        <div id="api-error" class="validation-error api-error" role="alert" aria-live="polite" style="display: none;">
                            <strong>{% trans "Fehler bei der Einsendung" %}</strong><br>
                            <span class="validation-error-text" id="api-error-text"></span>
                        </div>
                        <p>
                            <button class="button button-primary" type="button" id="button" aria-label="{% trans 'EinschÃ¤tzung bestÃ¤tigen' %}" title="{% trans 'Eingaben kÃ¶nnen nachtrÃ¤glich nicht geÃ¤ndert werden' %}">
                            <span class="button-text">{% trans "Ja, diese EinschÃ¤tzung passt" %}</span>
                            <span class="button-arrow">â†’</span>
                        </button>
                        </p>
                        <div class="copyright-footer">
                            <a href="https://github.com/joe-the-ark/ark" target="_blank">{% trans "ARKS is published under a GPLv3" %}</a> {% trans "license by" %} 
                            <a href="https://www.linkedin.com/in/dr-joe-maier/" target="_blank">{% trans "Dr. Joe Maier" %}</a>.
                        </div>
                    </div>

            </main>
        </div>
    </div>
</div>
<script src="/static/js/AppGraph.js"></script>
<script src="/static/jquery-3.5.1.min.js"></script>
<script src="/static/axios.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.min.js"></script>
    <script src="https://unpkg.com/tippy.js@6/dist/tippy-bundle.umd.js"></script>

<script>

    // Translated messages
    var ALERT_MESSAGE_PREFIX = "{% trans 'Bitte bewerte alle Teammitglieder. Noch nicht bewertet:'|escapejs %}";
    var PLAYER_LABEL = "{% trans 'Spieler'|escapejs %}";
    
    // ARKS Logo Tooltip
    const arksLogoContainer = document.querySelector('.header-main__title icon');
    const arksLogoTooltipIcon = document.getElementById('arks-logo-tooltip-icon');
    
    if (arksLogoContainer && arksLogoTooltipIcon) {
        arksLogoContainer.addEventListener('mouseenter', function() {
            arksLogoTooltipIcon.style.display = 'inline-flex';
        });
        arksLogoContainer.addEventListener('mouseleave', function() {
            arksLogoTooltipIcon.style.display = 'none';
        });
        
        tippy(arksLogoTooltipIcon, {
            content: "{% trans 'Info zu safecircles.ch'|escapejs %}",
            placement: 'bottom',
            theme: 'light',
            delay: [200, 0],
            allowHTML: false,
            interactive: false,
            trigger: 'mouseenter focus',
            maxWidth: 300,
        });
    }
    
    // Ubung-5 Tooltip - Initialize after DOM is ready
    function initUbung5Tooltip() {
        const ubung5TooltipIcon = document.getElementById('ubung5-tooltip-icon');
        if (ubung5TooltipIcon) {
            // Make sure icon is visible
            ubung5TooltipIcon.style.display = 'inline-flex';
            
            // Destroy existing tooltip if any
            const existingInstance = ubung5TooltipIcon._tippy;
            if (existingInstance) {
                existingInstance.destroy();
            }
            
            tippy(ubung5TooltipIcon, {
                content: "{% trans 'Nimm deine EinschÃ¤tzungen bitte spontan, intuitiv und fÃ¼r jeden Mitspieler vor. Folge dem ersten Eindruck oder BauchgefÃ¼hl, wenn ihr euch noch nicht so gut kennt.'|escapejs %}",
                placement: 'bottom',
                theme: 'light',
                delay: [200, 0],
                allowHTML: false,
                interactive: false,
                trigger: 'mouseenter focus',
                maxWidth: 500,
            });
        } else {
            console.warn('ubung5-tooltip-icon not found');
        }
    }
    
    // Initialize tooltip after DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initUbung5Tooltip);
    } else {
        initUbung5Tooltip();
    }

    // Track total votes cast across all tension pairs using localStorage
    // Key format: 'ubung5_votes_' + gameLink + '_' + userId
    var storageKey = 'ubung5_votes_{{game.link|escapejs}}_{{user.id}}';
    
    // Initialize or retrieve total votes from localStorage
    function getTotalVotesCast() {
        var stored = localStorage.getItem(storageKey);
        return stored ? parseInt(stored, 10) : 0;
    }
    
    function setTotalVotesCast(count) {
        localStorage.setItem(storageKey, count.toString());
    }
    
    function calculateVotingProgress() {
        // In ubung-5:
        // - Number of scales = number of players (10 players = 10 scales)
        // - Each player votes on all scales for each tension pair
        // - In a 10-player game: 10 scales Ã— 10 tension pairs = 100 votes per player
        // - Progress reflects total votes cast by current user (0 to 100 votes)
        
        // Get total number of players (scales) from current page
        var allSliders = document.querySelectorAll('.custom-graph__range');
        var totalPlayers = allSliders.length; // Number of players = number of scales
        
        // Count votes on current page (current tension pair)
        var votesOnCurrentPage = 0;
        var defaultValue = 50; // Default slider value when no vote has been made
        
        allSliders.forEach(function(slider) {
            var currentValue = parseInt(slider.value);
            // If slider has been moved from default (50), this is a vote
            if (!isNaN(currentValue) && currentValue !== defaultValue) {
                votesOnCurrentPage++;
            }
        });
        
        // Get total votes cast across all tension pairs from localStorage
        var totalVotesCast = getTotalVotesCast();
        
        // Calculate total votes needed: number of players Ã— number of players
        // (assuming one tension pair per player, or adjust based on actual number of tension pairs)
        // For now, we'll use: totalPlayers Ã— totalPlayers = totalVotesNeeded
        // In a 10-player game: 10 Ã— 10 = 100 votes
        var totalVotesNeeded = totalPlayers * totalPlayers;
        
        // Calculate progress: 40% (start) to 60% (end) = 20% range
        // Each vote contributes: 20% / totalVotesNeeded
        // Example with 100 votes needed: each vote = 0.2% (20% / 100 = 0.2%)
        var baseProgress = 40; // Start of ubung-5
        var targetProgress = 60; // End of ubung-5
        var progressRange = targetProgress - baseProgress; // 20%
        
        // Calculate progress based on total votes cast
        // Example with 100 votes needed (10 players):
        // - 0 votes: 40%
        // - 1 vote: 40% + (1/100) * 20% = 40% + 0.2% = 40.2%
        // - 10 votes: 40% + (10/100) * 20% = 40% + 2% = 42%
        // - 50 votes: 40% + (50/100) * 20% = 40% + 10% = 50%
        // - 100 votes: 40% + (100/100) * 20% = 40% + 20% = 60%
        var progressPerVote = totalVotesNeeded > 0 ? progressRange / totalVotesNeeded : 0;
        var progress = baseProgress + (totalVotesCast * progressPerVote);
        progress = Math.round(progress * 10) / 10; // Round to 1 decimal place for precision
        
        // Ensure progress stays within bounds
        if (progress < baseProgress) progress = baseProgress;
        if (progress > targetProgress) progress = targetProgress;
        
        return progress;
    }
    
    // Update total votes when sliders change
    function updateTotalVotesCount() {
        var allSliders = document.querySelectorAll('.custom-graph__range');
        var votesOnCurrentPage = 0;
        var defaultValue = 50;
        
        allSliders.forEach(function(slider) {
            var currentValue = parseInt(slider.value);
            if (!isNaN(currentValue) && currentValue !== defaultValue) {
                votesOnCurrentPage++;
            }
        });
        
        // Get previous total and current page votes
        var previousTotal = getTotalVotesCast();
        var currentTensionPairKey = storageKey + '_current_{{ubung1.id}}_{{ubung3.id}}';
        var previousPageVotes = parseInt(localStorage.getItem(currentTensionPairKey) || '0', 10);
        
        // Calculate new total: previous total - previous votes on this page + current votes on this page
        var newTotal = previousTotal - previousPageVotes + votesOnCurrentPage;
        
        // Update storage
        setTotalVotesCast(newTotal);
        localStorage.setItem(currentTensionPairKey, votesOnCurrentPage.toString());
    }
    
    function updateUbung5ProgressBar() {
        // Update total votes count first
        updateTotalVotesCount();
        
        // Calculate and display progress
        var progress = calculateVotingProgress();
        var progressBar = document.getElementById('ubung5-progress-bar');
        if (progressBar) {
            progressBar.style.width = progress + '%';
            progressBar.textContent = Math.round(progress) + '%';
            progressBar.setAttribute('aria-valuenow', progress);
            progressBar.setAttribute('aria-valuemin', '40');
            progressBar.setAttribute('aria-valuemax', '60');
            progressBar.setAttribute('role', 'progressbar');
            progressBar.setAttribute('aria-label', "{% trans 'Fortschritt'|escapejs %}: " + Math.round(progress) + "%");
        }
    }

    function validateAllPlayersVoted() {
        var allItems = document.querySelectorAll('.custom-graph__item');
        var missingVotes = [];
        var defaultValue = 50; // Default value when no interaction has occurred
        
        allItems.forEach(function(item, index) {
            // Get the range input slider
            var slider = item.querySelector('.custom-graph__range');
            if (slider) {
                var currentValue = parseInt(slider.value);
                // Check if slider is still at default value (hasn't been moved)
                if (currentValue === defaultValue) {
                    // Get the player's name
                    var nameElement = item.querySelector('.custom-graph__item-name');
                    var name = nameElement ? nameElement.textContent.trim() : PLAYER_LABEL + ' ' + (index + 1);
                    if (!name) {
                        // Try mobile name element
                        nameElement = item.querySelector('.custom-graph__item-name_mobile');
                        name = nameElement ? nameElement.textContent.trim() : PLAYER_LABEL + ' ' + (index + 1);
                    }
                    missingVotes.push(name);
                }
            }
        });
        
        if (missingVotes.length > 0) {
            // Show translated validation error instead of alert
            const validationError = document.getElementById('validation-error');
            const validationErrorText = document.getElementById('validation-error-text');
            const apiError = document.getElementById('api-error');
            
            if (validationError && validationErrorText) {
                // Hide API error if visible
                if (apiError) {
                    apiError.style.display = 'none';
                }
                
                // Show validation error with list of missing votes
                validationErrorText.textContent = ALERT_MESSAGE_PREFIX + "\n\n" + missingVotes.join('\n');
                validationError.style.display = 'block';
                validationError.setAttribute('role', 'alert');
                
                // Scroll to error message
                validationError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Hide error after 10 seconds
                setTimeout(function() {
                    if (validationError) {
                        validationError.style.display = 'none';
                    }
                }, 10000);
            } else {
                // Fallback to alert if elements not found
                var message = ALERT_MESSAGE_PREFIX + "\n\n" + missingVotes.join('\n');
                alert(message);
            }
            return false;
        }
        
        // Hide validation error if all players are voted
        const validationError = document.getElementById('validation-error');
        if (validationError) {
            validationError.style.display = 'none';
        }
        
        return true;
    }

    function data_submit(){
        // Validate that all players have been voted on
        if (!validateAllPlayersVoted()) {
            return;
        }
        
        // Disable button during submission
        const submitButton = document.getElementById('button');
        if (submitButton) {
            submitButton.disabled = true;
            submitButton.classList.add('button-submitting');
        }
        
        // Hide any existing errors
        const validationError = document.getElementById('validation-error');
        const apiError = document.getElementById('api-error');
        if (validationError) validationError.style.display = 'none';
        if (apiError) apiError.style.display = 'none';
        
        var data_ = {
            'link': '{{game.link}}',
            'user_id': '{{user.id}}',
            'data': $('#data').val(),
            'ubung1_id': '{{ubung1.id}}',
            'ubung3_id': '{{ubung3.id}}',
        }
        
        axios
            .post(`/api/ubung5_data/`, data_)
            .then(function(response){
                var result = response.data.result;
                
                // Re-enable button
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.classList.remove('button-submitting');
                }
                
                if (result === 1){
                    //window.location.href="/team-potential/";
                    window.location.href="/ubung-5/";
                }else{
                    // Show error message
                    const apiErrorText = document.getElementById('api-error-text');
                    if (apiError && apiErrorText) {
                        apiErrorText.textContent = "{% trans 'Die Einsendung war nicht erfolgreich. Bitte versuche es erneut.'|escapejs %}";
                        apiError.style.display = 'block';
                        apiError.setAttribute('role', 'alert');
                        setTimeout(function() {
                            if (apiError) {
                                apiError.style.display = 'none';
                            }
                        }, 8000);
                    }
                    return;
                }
            })
            .catch(function(error){
                // Re-enable button
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.classList.remove('button-submitting');
                }
                
                // Show error message
                const apiError = document.getElementById('api-error');
                const apiErrorText = document.getElementById('api-error-text');
                if (apiError && apiErrorText) {
                    apiErrorText.textContent = "{% trans 'Ein Fehler ist aufgetreten. Bitte versuche es erneut.'|escapejs %}";
                    apiError.style.display = 'block';
                    apiError.setAttribute('role', 'alert');
                    setTimeout(function() {
                        if (apiError) {
                            apiError.style.display = 'none';
                        }
                    }, 8000);
                }
            })
    }

    $('#button').click(function(){
        data_submit();
    })


    var lang_code = '{{LANGUAGE_CODE}}'

    const app = new AppGraph({
        container: ".custom-graph-wrapper",
        range: [0, 100],
        //labelRange: ['Low', 'High'],
        //labelRange: ['Kraftquelle', 'Energiefresser'],
        labelRange: [{{ubung1.power_i18n|safe}}[lang_code], {{ubung3.drainer_i18n|safe}}[lang_code]],

        mobile: 1200,
        data: {{ member_list|safe }},

    });

    document.getElementById('button').addEventListener('click', function (e) {
        //e.preventDefault();
        // Data is logged in data_submit function if needed for debugging
    });

    function refresh(){
        var result = app.getData();
        var st = JSON.stringify(result);
        $('#data').val(st);
        // Update progress bar when data refreshes
        updateUbung5ProgressBar();
    }
    setInterval("refresh()", 100);
    
    // Update progress bar immediately when any slider changes
    // Use event delegation to catch all slider changes, even dynamically added ones
    document.addEventListener('input', function(e) {
        if (e.target && e.target.classList && e.target.classList.contains('custom-graph__range')) {
            // Immediately update progress when a scale is voted
            updateUbung5ProgressBar();
        }
    });
    
    // Also listen for change events (when slider is released)
    document.addEventListener('change', function(e) {
        if (e.target && e.target.classList && e.target.classList.contains('custom-graph__range')) {
            updateUbung5ProgressBar();
        }
    });
    
    // Initialize vote tracking on page load
    // Count votes on current page and update total if this is the first time seeing this tension pair
    setTimeout(function() {
        var currentTensionPairKey = storageKey + '_current_{{ubung1.id}}_{{ubung3.id}}';
        var previousPageVotes = parseInt(localStorage.getItem(currentTensionPairKey) || '0', 10);
        
        // If we haven't tracked votes for this tension pair yet, count them now
        if (previousPageVotes === 0) {
            var allSliders = document.querySelectorAll('.custom-graph__range');
            var votesOnCurrentPage = 0;
            var defaultValue = 50;
            
            allSliders.forEach(function(slider) {
                var currentValue = parseInt(slider.value);
                if (!isNaN(currentValue) && currentValue !== defaultValue) {
                    votesOnCurrentPage++;
                }
            });
            
            // If there are votes on this page, add them to the total
            if (votesOnCurrentPage > 0) {
                var currentTotal = getTotalVotesCast();
                setTotalVotesCast(currentTotal + votesOnCurrentPage);
                localStorage.setItem(currentTensionPairKey, votesOnCurrentPage.toString());
            }
        }
        
        updateUbung5ProgressBar();
    }, 500);
    
    // Also update periodically to catch any missed updates
    setInterval(updateUbung5ProgressBar, 300);
    // window.addEventListener('resize', () => {
    //         console.log("resize");
            
            

    //     });

    </script>
    
    <script>
    // Reload page on window resize to fix graph connection lines
    let resizeTimeout;
    let lastWindowWidth = window.innerWidth;
    let lastWindowHeight = window.innerHeight;
    
    window.addEventListener('resize', function() {
        // Clear existing timeout
        if (resizeTimeout) {
            clearTimeout(resizeTimeout);
        }
        
        // Debounce resize event - wait 500ms after last resize before reloading
        resizeTimeout = setTimeout(function() {
            const currentWidth = window.innerWidth;
            const currentHeight = window.innerHeight;
            
            // Only reload if there's a significant size change (more than 50px difference)
            // This prevents unnecessary reloads during continuous resizing
            const widthDiff = Math.abs(currentWidth - lastWindowWidth);
            const heightDiff = Math.abs(currentHeight - lastWindowHeight);
            
            if (widthDiff > 50 || heightDiff > 50) {
                lastWindowWidth = currentWidth;
                lastWindowHeight = currentHeight;
                location.reload();
            }
        }, 500);
    });
</script>
</body>
</html>
